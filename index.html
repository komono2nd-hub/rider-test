<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0e1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ğŸï¸ ãƒã‚¤ã‚¯è»¢å£²ãƒŠãƒ“</title>

<!-- ZXing ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

<style>
/* ============================================================
   CSS ãƒªã‚»ãƒƒãƒˆ & å¤‰æ•°
   ============================================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #0a0e1a;
  --bg2:       #131929;
  --bg3:       #1c2540;
  --accent:    #ff6b35;
  --accent2:   #ff9f1c;
  --blue:      #4fc3f7;
  --green:     #66bb6a;
  --red:       #ef5350;
  --text:      #e8eaf6;
  --text2:     #90a4ae;
  --radius:    12px;
  --shadow:    0 4px 20px rgba(0,0,0,0.5);
}

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
  font-size: 16px;
  overflow-x: hidden;
}

/* ============================================================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ============================================================ */
.hidden  { display: none !important; }
.flex    { display: flex; }
.col     { flex-direction: column; }
.center  { align-items: center; justify-content: center; }
.gap8    { gap: 8px; }
.gap12   { gap: 12px; }
.gap16   { gap: 16px; }
.w100    { width: 100%; }
.mt8     { margin-top: 8px; }
.mt16    { margin-top: 16px; }

/* ============================================================
   ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç®¡ç†
   ============================================================ */
.screen {
  display: none;
  flex-direction: column;
  min-height: 100vh;
  padding: 16px;
  max-width: 480px;
  margin: 0 auto;
}
.screen.active { display: flex; }

/* ============================================================
   ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
   ============================================================ */
#screen-login {
  justify-content: center;
  align-items: center;
  gap: 24px;
  background: radial-gradient(ellipse at center, #1a2040 0%, var(--bg) 70%);
}

.login-logo {
  font-size: 72px;
  filter: drop-shadow(0 0 20px rgba(255,107,53,0.6));
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%,100% { filter: drop-shadow(0 0 20px rgba(255,107,53,0.6)); }
  50%      { filter: drop-shadow(0 0 35px rgba(255,107,53,0.9)); }
}

.login-title {
  font-size: 26px;
  font-weight: 700;
  text-align: center;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.login-subtitle {
  color: var(--text2);
  font-size: 13px;
  text-align: center;
}

.login-card {
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: var(--radius);
  padding: 28px 24px;
  width: 100%;
  max-width: 360px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group label {
  font-size: 12px;
  color: var(--text2);
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.form-group input {
  background: var(--bg3);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 14px 16px;
  color: var(--text);
  font-size: 16px;
  outline: none;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}

.form-group input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(255,107,53,0.2);
}

.btn {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none;
  border-radius: 10px;
  padding: 16px;
  color: white;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.2s;
  -webkit-tap-highlight-color: transparent;
  letter-spacing: 0.5px;
}

.btn:active    { transform: scale(0.97); }
.btn:disabled  { opacity: 0.5; cursor: not-allowed; }

.btn-outline {
  background: transparent;
  border: 2px solid var(--accent);
  color: var(--accent);
  border-radius: 10px;
  padding: 14px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
}
.btn-outline:active { transform: scale(0.97); background: rgba(255,107,53,0.1); }

.btn-ghost {
  background: var(--bg3);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text2);
  border-radius: 10px;
  padding: 14px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
}
.btn-ghost:active { transform: scale(0.97); background: var(--bg2); }

.login-error {
  background: rgba(239,83,80,0.15);
  border: 1px solid rgba(239,83,80,0.4);
  border-radius: 8px;
  padding: 12px;
  font-size: 13px;
  color: var(--red);
  text-align: center;
}

/* ============================================================
   ãƒ˜ãƒƒãƒ€ãƒ¼
   ============================================================ */
.app-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--bg2);
  border-bottom: 1px solid var(--bg3);
  position: sticky;
  top: 0;
  z-index: 100;
  max-width: 480px;
  margin: 0 auto;
  width: 100%;
}

.header-title {
  font-size: 17px;
  font-weight: 700;
  color: var(--accent);
}

.header-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.icon-btn {
  background: var(--bg3);
  border: none;
  border-radius: 8px;
  width: 38px;
  height: 38px;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.icon-btn:active { background: var(--bg); }

/* ============================================================
   åˆ©ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
   ============================================================ */
.usage-bar {
  background: var(--bg2);
  padding: 8px 16px;
  display: flex;
  gap: 12px;
  justify-content: center;
  border-bottom: 1px solid var(--bg3);
  max-width: 480px;
  margin: 0 auto;
  width: 100%;
}

.usage-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
}

.usage-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
}
.usage-dot.warn   { background: var(--accent2); }
.usage-dot.danger { background: var(--red); }

.usage-text { color: var(--text2); }
.usage-count { color: var(--text); font-weight: 600; }

.usage-mini-bar {
  flex: 1;
  height: 4px;
  background: var(--bg3);
  border-radius: 2px;
  overflow: hidden;
  max-width: 60px;
}
.usage-mini-fill {
  height: 100%;
  border-radius: 2px;
  background: var(--green);
  transition: width 0.3s, background 0.3s;
}

/* ============================================================
   ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ï¼ˆãƒ›ãƒ¼ãƒ ï¼‰
   ============================================================ */
#screen-home {
  padding: 0;
  gap: 0;
}

.main-content {
  flex: 1;
  padding: 20px 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-width: 480px;
  width: 100%;
  margin: 0 auto;
}

.home-greeting {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.home-greeting span { color: var(--accent); }

.action-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.action-card {
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: var(--radius);
  padding: 20px 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: transform 0.15s, border-color 0.2s, box-shadow 0.2s;
  -webkit-tap-highlight-color: transparent;
  text-align: center;
}

.action-card:active {
  transform: scale(0.96);
  border-color: var(--accent);
  box-shadow: 0 0 16px rgba(255,107,53,0.25);
}

.action-card.primary {
  grid-column: 1 / -1;
  flex-direction: row;
  text-align: left;
  gap: 16px;
  background: linear-gradient(135deg, #1a2540 0%, #0d1629 100%);
  border-color: rgba(255,107,53,0.3);
}

.action-card.primary .action-icon { font-size: 42px; }

.action-icon { font-size: 34px; }

.action-label {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.action-desc {
  font-size: 11px;
  color: var(--text2);
  line-height: 1.4;
}

/* å•†å“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ */
.section-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text2);
  letter-spacing: 0.5px;
  border-left: 3px solid var(--accent);
  padding-left: 10px;
}

.rank-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.rank-item {
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: 10px;
  padding: 12px 14px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.rank-badge {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 700;
  flex-shrink: 0;
}

.rank-badge.s { background: linear-gradient(135deg, #ffd700, #ffb300); color: #000; }
.rank-badge.a { background: linear-gradient(135deg, #78909c, #546e7a); color: #fff; }
.rank-badge.b { background: linear-gradient(135deg, #a1887f, #795548); color: #fff; }

.rank-info { flex: 1; }
.rank-name  { font-size: 14px; font-weight: 600; }
.rank-profit { font-size: 12px; color: var(--green); margin-top: 2px; }

.rank-diff {
  font-size: 13px;
  font-weight: 700;
  color: var(--accent);
  text-align: right;
}

/* ============================================================
   ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢
   ============================================================ */
#screen-scan {
  padding: 0;
  gap: 0;
}

.scan-content {
  flex: 1;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.video-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 4/3;
  background: #000;
  border-radius: var(--radius);
  overflow: hidden;
  border: 2px solid var(--bg3);
}

#video-preview {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.scan-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.scan-frame {
  width: 60%;
  aspect-ratio: 3/1;
  border: 2px solid rgba(255,107,53,0.8);
  border-radius: 4px;
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.45);
  position: relative;
}

.scan-frame::before {
  content: '';
  position: absolute;
  top: -1px;
  left: 10%;
  right: 10%;
  height: 2px;
  background: var(--accent);
  animation: scanline 2s ease-in-out infinite;
}

@keyframes scanline {
  0%   { top: 10%;  }
  100% { top: 85%;  }
}

.scan-hint {
  margin-top: 16px;
  color: rgba(255,255,255,0.7);
  font-size: 13px;
  text-align: center;
  background: rgba(0,0,0,0.5);
  padding: 6px 14px;
  border-radius: 20px;
}

.scan-result-box {
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: var(--radius);
  padding: 14px;
}

.scan-result-label {
  font-size: 11px;
  color: var(--text2);
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.scan-result-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--blue);
  margin-top: 4px;
  word-break: break-all;
}

/* ============================================================
   å†™çœŸè§£æç”»é¢
   ============================================================ */
#screen-photo {
  padding: 0;
  gap: 0;
}

.photo-content {
  flex: 1;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.capture-area {
  width: 100%;
  aspect-ratio: 4/3;
  background: var(--bg2);
  border: 2px dashed var(--bg3);
  border-radius: var(--radius);
  overflow: hidden;
  position: relative;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: border-color 0.2s;
}

.capture-area:active { border-color: var(--accent); }

.capture-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  color: var(--text2);
  pointer-events: none;
}

.capture-placeholder span { font-size: 52px; }
.capture-placeholder p    { font-size: 14px; }

#captured-img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

#file-input-photo {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
  width: 100%;
  height: 100%;
  font-size: 0;
}

input[type="file"] {
  -webkit-appearance: none;
}

/* ============================================================
   å€™è£œãƒªã‚¹ãƒˆ
   ============================================================ */
.candidate-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.candidate-item {
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: var(--radius);
  padding: 14px 16px;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  display: flex;
  align-items: center;
  gap: 12px;
  -webkit-tap-highlight-color: transparent;
}

.candidate-item:active, .candidate-item.selected {
  border-color: var(--accent);
  background: rgba(255,107,53,0.08);
}

.candidate-num {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: var(--bg3);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 700;
  color: var(--text2);
  flex-shrink: 0;
}

.candidate-item.selected .candidate-num {
  background: var(--accent);
  color: #fff;
}

.candidate-info { flex: 1; }
.candidate-name  { font-size: 14px; font-weight: 600; }
.candidate-meta  { font-size: 12px; color: var(--text2); margin-top: 2px; }

.confidence-bar {
  width: 50px;
  height: 6px;
  background: var(--bg3);
  border-radius: 3px;
  overflow: hidden;
  margin-top: 4px;
}
.confidence-fill {
  height: 100%;
  border-radius: 3px;
  background: var(--green);
}

/* ============================================================
   ä¾¡æ ¼ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰
   ============================================================ */
#screen-price {
  padding: 0;
  gap: 0;
}

.price-content {
  flex: 1;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.price-product-name {
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 14px;
  font-size: 15px;
  font-weight: 600;
  border-left: 4px solid var(--accent);
}

.price-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.price-card {
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: var(--radius);
  padding: 14px 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  cursor: pointer;
  text-decoration: none;
  transition: transform 0.15s, border-color 0.2s, box-shadow 0.2s;
  -webkit-tap-highlight-color: transparent;
}

.price-card:active {
  transform: scale(0.96);
  border-color: var(--accent);
  box-shadow: 0 0 12px rgba(255,107,53,0.2);
}

.price-card-header {
  display: flex;
  align-items: center;
  gap: 8px;
}

.price-card-icon { font-size: 22px; }

.price-card-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text2);
}

.price-card-type {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
}

.type-buy    { background: rgba(102,187,106,0.2); color: var(--green); }
.type-sell   { background: rgba(255,107,53,0.2);  color: var(--accent); }
.type-both   { background: rgba(79,195,247,0.2);  color: var(--blue); }

.price-card-desc {
  font-size: 11px;
  color: var(--text2);
  line-height: 1.5;
}

.price-card-btn {
  background: var(--bg3);
  border-radius: 6px;
  padding: 7px;
  text-align: center;
  font-size: 12px;
  color: var(--text);
  font-weight: 600;
  margin-top: 2px;
}

/* ============================================================
   ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
   ============================================================ */
.search-bar {
  display: flex;
  gap: 8px;
}

.search-input {
  flex: 1;
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: 10px;
  padding: 14px 16px;
  color: var(--text);
  font-size: 15px;
  outline: none;
  -webkit-appearance: none;
}

.search-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(255,107,53,0.15);
}

.search-btn {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none;
  border-radius: 10px;
  padding: 14px 18px;
  color: white;
  font-size: 20px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

/* ============================================================
   è¨­å®šç”»é¢
   ============================================================ */
#screen-settings {
  padding: 0;
  gap: 0;
}

.settings-content {
  flex: 1;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.settings-section {
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: var(--radius);
  overflow: hidden;
}

.settings-section-title {
  padding: 12px 16px;
  font-size: 13px;
  font-weight: 700;
  color: var(--text2);
  background: var(--bg3);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.settings-row {
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  border-bottom: 1px solid var(--bg3);
}

.settings-row:last-child { border-bottom: none; }

.settings-label {
  font-size: 14px;
  font-weight: 600;
}

.settings-desc {
  font-size: 12px;
  color: var(--text2);
  line-height: 1.5;
}

.settings-input {
  background: var(--bg3);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 12px 14px;
  color: var(--text);
  font-size: 15px;
  outline: none;
  -webkit-appearance: none;
}

.settings-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(255,107,53,0.15);
}

.api-key-row {
  display: flex;
  gap: 8px;
}

.api-key-row .settings-input { flex: 1; }

.toggle-visibility {
  background: var(--bg3);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 0 14px;
  color: var(--text2);
  font-size: 18px;
  cursor: pointer;
  flex-shrink: 0;
}

.usage-stats {
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.stat-row {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.stat-label-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.stat-label    { font-size: 13px; color: var(--text2); }
.stat-value    { font-size: 13px; font-weight: 700; }

.stat-bar {
  height: 8px;
  background: var(--bg3);
  border-radius: 4px;
  overflow: hidden;
}

.stat-fill {
  height: 100%;
  border-radius: 4px;
  background: var(--green);
  transition: width 0.4s, background 0.4s;
}

.stat-fill.warn   { background: var(--accent2); }
.stat-fill.danger { background: var(--red); }

/* ============================================================
   APIã‚µãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
   ============================================================ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 200;
  overflow-y: auto;
  padding: 16px;
}

.modal-overlay.active { display: block; }

.modal-card {
  background: var(--bg2);
  border: 1px solid var(--bg3);
  border-radius: var(--radius);
  max-width: 480px;
  margin: 0 auto;
  overflow: hidden;
}

.modal-header {
  background: linear-gradient(135deg, var(--bg3), var(--bg2));
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--bg3);
}

.modal-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--accent);
}

.modal-close {
  background: var(--bg3);
  border: none;
  border-radius: 8px;
  width: 34px;
  height: 34px;
  color: var(--text2);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-body {
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.step-card {
  background: var(--bg3);
  border-radius: 10px;
  padding: 16px;
  display: flex;
  gap: 14px;
}

.step-num {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff;
  font-size: 14px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.step-body { flex: 1; }

.step-title {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 6px;
}

.step-desc {
  font-size: 13px;
  color: var(--text2);
  line-height: 1.6;
}

.step-link {
  display: inline-block;
  margin-top: 8px;
  background: var(--accent);
  color: white;
  text-decoration: none;
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
}

.step-code {
  background: var(--bg);
  border-radius: 6px;
  padding: 8px 12px;
  font-family: monospace;
  font-size: 13px;
  color: var(--blue);
  margin-top: 6px;
  word-break: break-all;
}

.info-box {
  background: rgba(79,195,247,0.1);
  border: 1px solid rgba(79,195,247,0.3);
  border-radius: 10px;
  padding: 14px;
  font-size: 13px;
  color: var(--blue);
  line-height: 1.6;
}

.warn-box {
  background: rgba(255,159,28,0.1);
  border: 1px solid rgba(255,159,28,0.3);
  border-radius: 10px;
  padding: 14px;
  font-size: 13px;
  color: var(--accent2);
  line-height: 1.6;
}

/* ============================================================
   ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
   ============================================================ */
.loading-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(10,14,26,0.9);
  z-index: 300;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
}

.loading-overlay.active { display: flex; }

.spinner {
  width: 52px;
  height: 52px;
  border: 4px solid var(--bg3);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  font-size: 15px;
  color: var(--text2);
}

/* ============================================================
   ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
   ============================================================ */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--bg3);
  color: var(--text);
  padding: 12px 20px;
  border-radius: 24px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: var(--shadow);
  z-index: 400;
  transition: transform 0.3s ease;
  white-space: nowrap;
  max-width: 90vw;
  text-align: center;
}

.toast.show { transform: translateX(-50%) translateY(0); }
.toast.success { background: var(--green); color: #fff; }
.toast.error   { background: var(--red);   color: #fff; }
.toast.warn    { background: var(--accent2); color: #000; }

/* ============================================================
   ã‚¿ãƒ–ãƒãƒ¼
   ============================================================ */
.tab-bar {
  display: flex;
  background: var(--bg2);
  border-top: 1px solid var(--bg3);
  position: sticky;
  bottom: 0;
  z-index: 50;
  max-width: 480px;
  margin: 0 auto;
  width: 100%;
}

.tab-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px 4px;
  cursor: pointer;
  transition: color 0.2s;
  -webkit-tap-highlight-color: transparent;
  color: var(--text2);
  font-size: 10px;
  gap: 3px;
  border: none;
  background: none;
}

.tab-item.active { color: var(--accent); }
.tab-icon { font-size: 22px; }

/* ============================================================
   ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª
   ============================================================ */
@media (min-width: 481px) {
  .screen, .app-header, .usage-bar, .tab-bar {
    box-shadow: 0 0 40px rgba(0,0,0,0.6);
  }
}

/* ============================================================
   ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼
   ============================================================ */
::-webkit-scrollbar       { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--bg3); border-radius: 2px; }
</style>
</head>
<body>

<!-- ============================================================
     ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
     ============================================================ -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loading-text">è§£æä¸­...</div>
</div>

<!-- ============================================================
     ãƒˆãƒ¼ã‚¹ãƒˆ
     ============================================================ -->
<div class="toast" id="toast"></div>

<!-- ============================================================
     API ã‚µãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
     ============================================================ -->
<div class="modal-overlay" id="modal-api-support">
  <div class="modal-card">
    <div class="modal-header">
      <span class="modal-title">ğŸ”‘ Gemini APIã‚­ãƒ¼å–å¾—ã‚¬ã‚¤ãƒ‰</span>
      <button class="modal-close" onclick="closeModal('modal-api-support')">âœ•</button>
    </div>
    <div class="modal-body">

      <div class="info-box">
        ğŸ“Œ Gemini APIã¯<strong>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã—</strong>ã§ã¯å–å¾—ã§ãã¾ã›ã‚“ã€‚<br>
        ãŸã ã—ã€å°‚ç”¨ã®ç„¡æ–™Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’1ã¤ä½œã‚‹ã ã‘ã§<strong>1æ—¥1,500å›ãƒ»ç„¡æ–™</strong>ã§ä½¿ãˆã¾ã™ã€‚
      </div>

      <div class="step-card">
        <div class="step-num">1</div>
        <div class="step-body">
          <div class="step-title">Google AI Studioã«ã‚¢ã‚¯ã‚»ã‚¹</div>
          <div class="step-desc">ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’é–‹ãã€Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚ï¼ˆå°‚ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã§ã‚‚OKï¼‰</div>
          <a class="step-link" href="https://aistudio.google.com/app/apikey" target="_blank">
            ğŸŒ Google AI Studio ã‚’é–‹ã
          </a>
        </div>
      </div>

      <div class="step-card">
        <div class="step-num">2</div>
        <div class="step-body">
          <div class="step-title">ã€ŒAPIã‚­ãƒ¼ã‚’ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
          <div class="step-desc">ãƒšãƒ¼ã‚¸å·¦å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒGet API keyã€ã¾ãŸã¯ã€ŒAPIã‚­ãƒ¼ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚</div>
        </div>
      </div>

      <div class="step-card">
        <div class="step-num">3</div>
        <div class="step-body">
          <div class="step-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ã‚­ãƒ¼ã‚’ç™ºè¡Œ</div>
          <div class="step-desc">ã€Œæ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§APIã‚­ãƒ¼ã‚’ä½œæˆã€ã‚’é¸æŠã€‚ç™ºè¡Œã•ã‚ŒãŸã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚</div>
          <div class="step-code">AIzaSyã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ï¼ˆä¾‹ï¼‰</div>
        </div>
      </div>

      <div class="step-card">
        <div class="step-num">4</div>
        <div class="step-body">
          <div class="step-title">ã“ã®ã‚¢ãƒ—ãƒªã®è¨­å®šã«è²¼ã‚Šä»˜ã‘</div>
          <div class="step-desc">ã‚¢ãƒ—ãƒªä¸‹éƒ¨ã®ã‚¿ãƒ–ã€Œâš™ï¸è¨­å®šã€â†’ã€ŒGemini APIã‚­ãƒ¼ã€æ¬„ã«ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ã€Œä¿å­˜ã€ã‚’æŠ¼ã—ã¾ã™ã€‚</div>
        </div>
      </div>

      <div class="step-card">
        <div class="step-num">5</div>
        <div class="step-body">
          <div class="step-title">å‹•ä½œç¢ºèª</div>
          <div class="step-desc">ğŸ“·å†™çœŸè§£æã‚¿ãƒ–ã§å•†å“ã‚’æ’®å½±ã—ã€ã€ŒAIè§£æé–‹å§‹ã€ã‚’æŠ¼ã—ã¦å€™è£œãŒè¡¨ç¤ºã•ã‚Œã‚Œã°è¨­å®šå®Œäº†ã§ã™ï¼</div>
        </div>
      </div>

      <div class="warn-box">
        âš ï¸ <strong>ç„¡æ–™æ ã®ä¸Šé™</strong><br>
        â€¢ 1åˆ†é–“ã«15å›ã¾ã§<br>
        â€¢ 1æ—¥1,500å›ã¾ã§<br>
        è¶…ãˆã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ãŒã€ç¿Œæ—¥/ç¿Œåˆ†ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
      </div>

      <div class="info-box">
        ğŸ’¡ <strong>APIã‚­ãƒ¼ã‚’ç§˜å¯†ã«ã—ã¦ãã ã•ã„</strong><br>
        ä»–äººã«æ•™ãˆã‚‹ã¨ç„¡æ–­åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒªã¯ã‚­ãƒ¼ã‚’ãŠä½¿ã„ã®ã‚¹ãƒãƒ›å†…ã«ã®ã¿ä¿å­˜ã—ã€å¤–éƒ¨ã«ã¯é€ä¿¡ã—ã¾ã›ã‚“ã€‚
      </div>

      <button class="btn" onclick="closeModal('modal-api-support')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- ============================================================
     ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
     ============================================================ -->
<div class="screen active" id="screen-login">
  <div class="login-logo">ğŸï¸</div>
  <div class="login-title">ãƒã‚¤ã‚¯è»¢å£²ãƒŠãƒ“</div>
  <div class="login-subtitle">ä»•å…¥ã‚Œâ†’ç›¸å ´ç¢ºèªâ†’åˆ©ç›Šæœ€å¤§åŒ–</div>
  <div class="login-card">
    <div class="form-group">
      <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
      <input type="text" id="login-id" placeholder="IDã‚’å…¥åŠ›" autocomplete="username" autocapitalize="none">
    </div>
    <div class="form-group">
      <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="password" id="login-pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="current-password">
    </div>
    <div class="login-error hidden" id="login-error">âŒ IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™</div>
    <button class="btn" id="login-btn" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>
  <div style="text-align:center; font-size:11px; color:var(--text2); margin-top:8px;">
    åˆå›ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã¯HTMLå†…ã‚’å‚ç…§ã—ã¦ãã ã•ã„
  </div>
</div>

<!-- ============================================================
     ãƒ›ãƒ¼ãƒ ç”»é¢
     ============================================================ -->
<div class="screen" id="screen-home">
  <div class="app-header">
    <div class="header-title">ğŸï¸ è»¢å£²ãƒŠãƒ“</div>
    <div class="header-actions">
      <button class="icon-btn" onclick="openModal('modal-api-support')" title="APIãƒ˜ãƒ«ãƒ—">ğŸ”‘</button>
      <button class="icon-btn" onclick="doLogout()" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">ğŸšª</button>
    </div>
  </div>

  <div class="usage-bar">
    <div class="usage-item">
      <div class="usage-dot" id="dot-min"></div>
      <span class="usage-text">ä»Šåˆ†:</span>
      <span class="usage-count" id="cnt-min">0</span><span class="usage-text">/15</span>
      <div class="usage-mini-bar">
        <div class="usage-mini-fill" id="bar-min" style="width:0%"></div>
      </div>
    </div>
    <div class="usage-item">
      <div class="usage-dot" id="dot-day"></div>
      <span class="usage-text">ä»Šæ—¥:</span>
      <span class="usage-count" id="cnt-day">0</span><span class="usage-text">/1500</span>
      <div class="usage-mini-bar">
        <div class="usage-mini-fill" id="bar-day" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="home-greeting">ã‚ˆã†ã“ãã€<span id="greeting-user">ãƒ©ã‚¤ãƒ€ãƒ¼</span>ã•ã‚“ğŸ‘‹</div>

    <div class="action-grid">
      <div class="action-card primary" onclick="showScreen('screen-photo')">
        <div class="action-icon">ğŸ“·</div>
        <div>
          <div class="action-label">å†™çœŸã§AIè§£æ</div>
          <div class="action-desc">å•†å“ã‚’æ’®å½±ã—ã¦AIãŒè‡ªå‹•ç‰¹å®šãƒ»ç›¸å ´ã‚’è¡¨ç¤º</div>
        </div>
      </div>
      <div class="action-card" onclick="showScreen('screen-scan')">
        <div class="action-icon">ğŸ“¦</div>
        <div class="action-label">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</div>
        <div class="action-desc">JAN/EANã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
      </div>
      <div class="action-card" onclick="showScreen('screen-search')">
        <div class="action-icon">ğŸ”</div>
        <div class="action-label">ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</div>
        <div class="action-desc">å•†å“åã§ç›¸å ´ç¢ºèª</div>
      </div>
      <div class="action-card" onclick="showModal('modal-api-support')">
        <div class="action-icon">ğŸ”‘</div>
        <div class="action-label">APIè¨­å®š</div>
        <div class="action-desc">Geminiã‚­ãƒ¼å–å¾—ã‚¬ã‚¤ãƒ‰</div>
      </div>
    </div>

    <div class="section-title">ãŠã™ã™ã‚è»¢å£²å•†å“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>

    <div class="rank-list">
      <div class="rank-item" onclick="quickSearch('ãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆ PS2 ãƒ•ã‚¡ãƒŸã‚³ãƒ³')">
        <div class="rank-badge s">S</div>
        <div class="rank-info">
          <div class="rank-name">ğŸ® ãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆ</div>
          <div class="rank-profit">ä»•å…¥500å††ã€œ / åˆ©ç›Š1,000ã€œ8,000å††</div>
        </div>
        <div class="rank-diff">x8å€</div>
      </div>
      <div class="rank-item" onclick="quickSearch('éŠæˆ¯ç‹ã‚«ãƒ¼ãƒ‰ MTGãƒˆãƒ¬ã‚« ãƒ¬ã‚¢')">
        <div class="rank-badge s">S</div>
        <div class="rank-info">
          <div class="rank-name">ğŸƒ ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰</div>
          <div class="rank-profit">ä»•å…¥100å††ã€œ / åˆ©ç›Š300ã€œ10,000å††</div>
        </div>
        <div class="rank-diff">x10å€</div>
      </div>
      <div class="rank-item" onclick="quickSearch('Nikon Canon ãƒ¬ãƒ³ã‚º ãƒ•ã‚£ãƒ«ãƒ ã‚«ãƒ¡ãƒ©')">
        <div class="rank-badge s">S</div>
        <div class="rank-info">
          <div class="rank-name">ğŸ“¸ ã‚«ãƒ¡ãƒ©ãƒ»ãƒ¬ãƒ³ã‚º</div>
          <div class="rank-profit">ä»•å…¥1,500å††ã€œ / åˆ©ç›Š2,000ã€œ15,000å††</div>
        </div>
        <div class="rank-diff">x6å€</div>
      </div>
      <div class="rank-item" onclick="quickSearch('Paul Smith COACH è²¡å¸ƒ ãƒ–ãƒ©ãƒ³ãƒ‰')">
        <div class="rank-badge s">S</div>
        <div class="rank-info">
          <div class="rank-name">ğŸ‘œ ãƒ–ãƒ©ãƒ³ãƒ‰è²¡å¸ƒãƒ»å°ç‰©</div>
          <div class="rank-profit">ä»•å…¥1,000å††ã€œ / åˆ©ç›Š3,000ã€œ15,000å††</div>
        </div>
        <div class="rank-diff">x5å€</div>
      </div>
      <div class="rank-item" onclick="quickSearch('ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹ ãƒ‘ã‚¿ã‚´ãƒ‹ã‚¢ ãƒ¢ãƒ³ãƒ™ãƒ« ã‚¸ãƒ£ã‚±ãƒƒãƒˆ')">
        <div class="rank-badge a">A</div>
        <div class="rank-info">
          <div class="rank-name">ğŸ§¥ ãƒ–ãƒ©ãƒ³ãƒ‰å¤ç€</div>
          <div class="rank-profit">ä»•å…¥1,500å††ã€œ / åˆ©ç›Š3,000ã€œ10,000å††</div>
        </div>
        <div class="rank-diff">x4å€</div>
      </div>
      <div class="rank-item" onclick="quickSearch('Nike ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼ ã‚³ãƒ©ãƒœ é™å®š')">
        <div class="rank-badge a">A</div>
        <div class="rank-info">
          <div class="rank-name">ğŸ‘Ÿ é™å®šã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼</div>
          <div class="rank-profit">ä»•å…¥2,500å††ã€œ / åˆ©ç›Š3,000ã€œ15,000å††</div>
        </div>
        <div class="rank-diff">x5å€</div>
      </div>
      <div class="rank-item" onclick="quickSearch('LEGO ãƒ¬ã‚´ å»ƒç›¤ ãƒ¬ã‚¢ ã‚»ãƒƒãƒˆ')">
        <div class="rank-badge a">A</div>
        <div class="rank-info">
          <div class="rank-name">ğŸ§± LEGOãƒ»ãƒŸãƒ‹å››é§†</div>
          <div class="rank-profit">ä»•å…¥500å††ã€œ / åˆ©ç›Š1,500ã€œ8,000å††</div>
        </div>
        <div class="rank-diff">x5å€</div>
      </div>
      <div class="rank-item" onclick="quickSearch('ã‚¹ãƒãƒ¼ãƒ”ãƒ¼ã‚¯ ã‚³ãƒ¼ãƒ«ãƒãƒ³ ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ å°ç‰©')">
        <div class="rank-badge b">B</div>
        <div class="rank-info">
          <div class="rank-name">â›º ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢å°ç‰©</div>
          <div class="rank-profit">ä»•å…¥500å††ã€œ / åˆ©ç›Š1,500ã€œ8,000å††</div>
        </div>
        <div class="rank-diff">x4å€</div>
      </div>
    </div>
  </div>

  <div class="tab-bar">
    <button class="tab-item active" onclick="showScreen('screen-home');setActiveTab(this)">
      <span class="tab-icon">ğŸ </span>ãƒ›ãƒ¼ãƒ 
    </button>
    <button class="tab-item" onclick="showScreen('screen-photo');setActiveTab(this)">
      <span class="tab-icon">ğŸ“·</span>å†™çœŸ
    </button>
    <button class="tab-item" onclick="showScreen('screen-scan');setActiveTab(this)">
      <span class="tab-icon">ğŸ“¦</span>ã‚¹ã‚­ãƒ£ãƒ³
    </button>
    <button class="tab-item" onclick="showScreen('screen-search');setActiveTab(this)">
      <span class="tab-icon">ğŸ”</span>æ¤œç´¢
    </button>
    <button class="tab-item" onclick="showScreen('screen-settings');setActiveTab(this)">
      <span class="tab-icon">âš™ï¸</span>è¨­å®š
    </button>
  </div>
</div>

<!-- ============================================================
     ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢
     ============================================================ -->
<div class="screen" id="screen-scan">
  <div class="app-header">
    <button class="icon-btn" onclick="goBack()">â—€</button>
    <div class="header-title">ğŸ“¦ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</div>
    <div style="width:38px"></div>
  </div>

  <div class="scan-content">
    <div class="video-wrapper">
      <video id="video-preview" playsinline autoplay muted></video>
      <div class="scan-overlay">
        <div class="scan-frame"></div>
        <div class="scan-hint">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ»QRã‚³ãƒ¼ãƒ‰ã‚’ãƒ©ã‚¤ãƒ³ã«åˆã‚ã›ã¦</div>
      </div>
    </div>

    <div class="scan-result-box" id="scan-result-box" style="display:none">
      <div class="scan-result-label">ã‚¹ã‚­ãƒ£ãƒ³çµæœ</div>
      <div class="scan-result-value" id="scan-result-value"></div>
    </div>

    <button class="btn-ghost" id="btn-stop-scan" onclick="stopScan()">ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
  </div>
</div>

<!-- ============================================================
     å†™çœŸè§£æç”»é¢
     ============================================================ -->
<div class="screen" id="screen-photo">
  <div class="app-header">
    <button class="icon-btn" onclick="goBack()">â—€</button>
    <div class="header-title">ğŸ“· å†™çœŸã§AIè§£æ</div>
    <button class="icon-btn" onclick="openModal('modal-api-support')">ğŸ”‘</button>
  </div>

  <div class="photo-content">
    <div class="capture-area" id="capture-area">
      <div class="capture-placeholder" id="capture-placeholder">
        <span>ğŸ“·</span>
        <p>ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’æ’®å½±<br>ã¾ãŸã¯é¸æŠ</p>
      </div>
      <img id="captured-img" class="hidden">
      <input type="file" id="file-input-photo" accept="image/*" capture="environment" onchange="onImageSelected(this)">
    </div>

    <button class="btn" id="btn-analyze" onclick="analyzeImage()" disabled>AIè§£æé–‹å§‹ ğŸ”</button>

    <div id="candidate-section" class="hidden">
      <div class="section-title" style="margin-bottom:10px">å€™è£œå•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div class="candidate-list" id="candidate-list"></div>
      <button class="btn" id="btn-to-price" onclick="goToPrice()" style="margin-top:12px" disabled>
        ã“ã®å•†å“ã§ç›¸å ´ã‚’è¦‹ã‚‹ â†’
      </button>
    </div>
  </div>
</div>

<!-- ============================================================
     ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ç”»é¢
     ============================================================ -->
<div class="screen" id="screen-search">
  <div class="app-header">
    <button class="icon-btn" onclick="goBack()">â—€</button>
    <div class="header-title">ğŸ” ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</div>
    <div style="width:38px"></div>
  </div>

  <div style="padding:16px;display:flex;flex-direction:column;gap:16px;">
    <div class="search-bar">
      <input class="search-input" id="text-search-input" type="text" placeholder="ä¾‹: PS2 ãƒ­ãƒã‚µã‚¬ã€ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹ ãƒ‘ãƒ¼ã‚«ãƒ¼"
             onkeydown="if(event.key==='Enter')doTextSearch()">
      <button class="search-btn" onclick="doTextSearch()">ğŸ”</button>
    </div>

    <div id="text-candidate-section" class="hidden">
      <div class="section-title" style="margin-bottom:10px">å€™è£œå•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div class="candidate-list" id="text-candidate-list"></div>
      <button class="btn" id="btn-text-to-price" onclick="goToPrice()" style="margin-top:12px" disabled>
        ã“ã®å•†å“ã§ç›¸å ´ã‚’è¦‹ã‚‹ â†’
      </button>
    </div>

    <!-- ã‚ˆãæ¤œç´¢ã•ã‚Œã‚‹å•†å“ã‚¿ã‚° -->
    <div class="section-title">ğŸ’¡ ã‚ˆãèª¿ã¹ã‚‹å•†å“ã‚¿ã‚°</div>
    <div style="display:flex;flex-wrap:wrap;gap:8px;">
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;"
              onclick="setSearchAndGo('PS2 ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆ')">ğŸ® PS2ã‚½ãƒ•ãƒˆ</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;"
              onclick="setSearchAndGo('éŠæˆ¯ç‹ ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰')">ğŸƒ éŠæˆ¯ç‹</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;"
              onclick="setSearchAndGo('ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹ ã‚¸ãƒ£ã‚±ãƒƒãƒˆ')">ğŸ§¥ ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;"
              onclick="setSearchAndGo('Nikon ãƒ¬ãƒ³ã‚º')">ğŸ“¸ Nikonãƒ¬ãƒ³ã‚º</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;"
              onclick="setSearchAndGo('LEGO ãƒ¬ã‚´ å»ƒç›¤')">ğŸ§± LEGOå»ƒç›¤</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;"
              onclick="setSearchAndGo('ã‚¹ãƒãƒ¼ãƒ”ãƒ¼ã‚¯ ã‚¯ãƒƒã‚«ãƒ¼')">â›º ã‚¹ãƒãƒ¼ãƒ”ãƒ¼ã‚¯</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;"
              onclick="setSearchAndGo('Nike ã‚¨ã‚¢ãƒ•ã‚©ãƒ¼ã‚¹ ã‚³ãƒ©ãƒœ')">ğŸ‘Ÿ Nikeã‚³ãƒ©ãƒœ</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;"
              onclick="setSearchAndGo('Paul Smith è²¡å¸ƒ')">ğŸ‘œ ãƒãƒ¼ãƒ«ã‚¹ãƒŸã‚¹</button>
    </div>
  </div>
</div>

<!-- ============================================================
     ä¾¡æ ¼ãƒªãƒ³ã‚¯ç”»é¢
     ============================================================ -->
<div class="screen" id="screen-price">
  <div class="app-header">
    <button class="icon-btn" onclick="goBack()">â—€</button>
    <div class="header-title">ğŸ’° å„ã‚µã‚¤ãƒˆç›¸å ´</div>
    <div style="width:38px"></div>
  </div>

  <div class="price-content">
    <div class="price-product-name" id="price-product-name">å•†å“å</div>

    <div class="section-title">ğŸ”´ ãƒ•ãƒªãƒãƒ»ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå£²å€¤ç›¸å ´ï¼‰</div>
    <div class="price-grid" id="price-sell-grid"></div>

    <div class="section-title">ğŸ”µ ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ï¼ˆä»•å…¥ã‚Œå‚è€ƒï¼‰</div>
    <div class="price-grid" id="price-buy-grid"></div>

    <div class="section-title">ğŸŸ¢ ä»•å…¥ã‚Œå…ˆï¼ˆãƒªã‚µã‚¤ã‚¯ãƒ«ã‚·ãƒ§ãƒƒãƒ—ï¼‰</div>
    <div class="price-grid" id="price-recycle-grid"></div>
  </div>
</div>

<!-- ============================================================
     è¨­å®šç”»é¢
     ============================================================ -->
<div class="screen" id="screen-settings">
  <div class="app-header">
    <button class="icon-btn" onclick="goBack()">â—€</button>
    <div class="header-title">âš™ï¸ è¨­å®š</div>
    <div style="width:38px"></div>
  </div>

  <div class="settings-content">

    <!-- APIã‚­ãƒ¼è¨­å®š -->
    <div class="settings-section">
      <div class="settings-section-title">ğŸ”‘ Gemini APIã‚­ãƒ¼</div>
      <div class="settings-row">
        <div class="settings-label">Gemini API Key</div>
        <div class="settings-desc">å†™çœŸè§£æAIæ©Ÿèƒ½ã«å¿…è¦ã§ã™ã€‚ç„¡æ–™ã§å–å¾—ã§ãã¾ã™ã€‚</div>
        <div class="api-key-row">
          <input class="settings-input" type="password" id="settings-api-key" placeholder="AIzaSy...">
          <button class="toggle-visibility" onclick="toggleApiKeyVisibility()">ğŸ‘</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:4px;">
          <button class="btn w100" onclick="saveApiKey()">ä¿å­˜</button>
          <button class="btn-outline" onclick="openModal('modal-api-support')" style="white-space:nowrap;padding:14px 12px;font-size:13px;">
            å–å¾—æ–¹æ³•
          </button>
        </div>
      </div>
    </div>

    <!-- åˆ©ç”¨çŠ¶æ³ -->
    <div class="settings-section">
      <div class="settings-section-title">ğŸ“Š APIåˆ©ç”¨çŠ¶æ³</div>
      <div class="usage-stats">
        <div class="stat-row">
          <div class="stat-label-row">
            <span class="stat-label">ä»Šåˆ†ã®åˆ©ç”¨å›æ•°</span>
            <span class="stat-value" id="stat-min-val">0 / 15å›</span>
          </div>
          <div class="stat-bar">
            <div class="stat-fill" id="stat-min-bar" style="width:0%"></div>
          </div>
        </div>
        <div class="stat-row">
          <div class="stat-label-row">
            <span class="stat-label">ä»Šæ—¥ã®åˆ©ç”¨å›æ•°</span>
            <span class="stat-value" id="stat-day-val">0 / 1500å›</span>
          </div>
          <div class="stat-bar">
            <div class="stat-fill" id="stat-day-bar" style="width:0%"></div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--text2);line-height:1.6;">
          ğŸ“… æ¬¡ã®æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆ: <span id="next-reset-time">-</span><br>
          ğŸ”„ æ¬¡ã®åˆ†æ¬¡ãƒªã‚»ãƒƒãƒˆ: 60ç§’ã”ã¨è‡ªå‹•æ›´æ–°
        </div>
        <button class="btn-ghost" onclick="resetUsage()">åˆ©ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±å¤‰æ›´ -->
    <div class="settings-section">
      <div class="settings-section-title">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±å¤‰æ›´</div>
      <div class="settings-row">
        <div class="settings-label">æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</div>
        <input class="settings-input" type="text" id="new-userid" placeholder="æ–°ã—ã„IDï¼ˆè‹±æ•°å­—ï¼‰" autocapitalize="none">
      </div>
      <div class="settings-row">
        <div class="settings-label">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
        <input class="settings-input" type="password" id="new-password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰">
      </div>
      <div class="settings-row">
        <div class="settings-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</div>
        <input class="settings-input" type="password" id="new-password2" placeholder="å†å…¥åŠ›">
      </div>
      <div class="settings-row" style="border-bottom:none;">
        <button class="btn" onclick="changeCredentials()">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å¤‰æ›´</button>
        <div class="settings-desc" style="margin-top:4px;">âš ï¸ å¤‰æ›´å¾Œã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆHTMLã«ã¯åæ˜ ã•ã‚Œã¾ã›ã‚“ï¼‰</div>
      </div>
    </div>

    <!-- ã‚¢ãƒ—ãƒªæƒ…å ± -->
    <div class="settings-section">
      <div class="settings-section-title">â„¹ï¸ ã‚¢ãƒ—ãƒªæƒ…å ±</div>
      <div class="settings-row">
        <div class="settings-label">ãƒã‚¤ã‚¯è»¢å£²ãƒŠãƒ“</div>
        <div class="settings-desc">
          ãƒã‚¤ã‚¯ãƒ„ãƒ¼ãƒªãƒ³ã‚°ä¸­ã®ãƒªã‚µã‚¤ã‚¯ãƒ«ã‚·ãƒ§ãƒƒãƒ—ä»•å…¥ã‚Œï¼†ãƒ•ãƒªãƒã‚¢ãƒ—ãƒªè»¢å£²ã‚’æ”¯æ´ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚<br>
          <br>
          ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2.0.0<br>
          å¯¾å¿œæ©Ÿèƒ½: ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã€AIå†™çœŸè§£æã€ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ã€ä¾¡æ ¼ãƒªãƒ³ã‚¯è¡¨ç¤º<br>
          <br>
          â€»æœ¬ã‚¢ãƒ—ãƒªã¯å•†å“ã®è»¢å£²ç›®çš„ã§ã®ç¶™ç¶šåˆ©ç”¨ã«ã¯å¤ç‰©å•†è¨±å¯ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
        </div>
      </div>
    </div>

    <button class="btn-ghost" onclick="doLogout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<!-- ============================================================
     JavaScript
     ============================================================ -->
<script>
/* ============================================================
   å®šæ•° & ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèªè¨¼æƒ…å ±
   ============================================================
   âš ï¸ å¤‰æ›´ã™ã‚‹å ´åˆã¯ã“ã“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„
   HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã«åæ˜ ã•ã‚Œã¾ã™
   ============================================================ */
const DEFAULT_USER_ID  = 'rider';
const DEFAULT_PASSWORD = 'sedori2025';

const API_LIMIT_PER_MIN = 15;
const API_LIMIT_PER_DAY = 1500;

// ============================================================
//  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ============================================================
const $ = id => document.getElementById(id);

function showToast(msg, type = '', duration = 2800) {
  const t = $('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => { t.className = 'toast'; }, duration);
}

function showLoading(msg = 'è§£æä¸­...') {
  $('loading-text').textContent = msg;
  $('loading').classList.add('active');
}

function hideLoading() {
  $('loading').classList.remove('active');
}

function openModal(id) { $(id).classList.add('active'); }
function closeModal(id) { $(id).classList.remove('active'); }
// ãƒ›ãƒ¼ãƒ ã®action-cardç”¨
function showModal(id) { openModal(id); }

// ============================================================
//  ç”»é¢ç®¡ç†
// ============================================================
const screens = ['screen-login','screen-home','screen-scan','screen-photo',
                 'screen-search','screen-price','screen-settings'];
let screenHistory = [];

function showScreen(id) {
  const prev = screens.find(s => $(s).classList.contains('active'));
  if (prev && prev !== id) screenHistory.push(prev);

  screens.forEach(s => $(s).classList.remove('active'));
  $(id).classList.add('active');

  if (id === 'screen-scan') startScan();
  else                       stopScan();
}

function goBack() {
  if (screenHistory.length) {
    const prev = screenHistory.pop();
    screens.forEach(s => $(s).classList.remove('active'));
    $(prev).classList.add('active');
    if (prev === 'screen-scan') startScan();
    else                         stopScan();
  } else {
    showScreen('screen-home');
  }
}

function setActiveTab(el) {
  document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
}

// ============================================================
//  èªè¨¼
// ============================================================
function getCredentials() {
  return {
    id: localStorage.getItem('auth_id') || DEFAULT_USER_ID,
    pw: localStorage.getItem('auth_pw') || DEFAULT_PASSWORD
  };
}

function doLogin() {
  const id = $('login-id').value.trim();
  const pw = $('login-pw').value.trim();
  const cred = getCredentials();

  if (id === cred.id && pw === cred.pw) {
    $('login-error').classList.add('hidden');
    localStorage.setItem('session', '1');
    showScreen('screen-home');
    $('greeting-user').textContent = id;
    loadApiKey();
    updateUsageUI();
  } else {
    $('login-error').classList.remove('hidden');
    $('login-pw').value = '';
  }
}

function doLogout() {
  localStorage.removeItem('session');
  stopScan();
  screenHistory = [];
  screens.forEach(s => $(s).classList.remove('active'));
  $('screen-login').classList.add('active');
  $('login-id').value = '';
  $('login-pw').value = '';
}

function changeCredentials() {
  const newId = $('new-userid').value.trim();
  const newPw = $('new-password').value;
  const newPw2 = $('new-password2').value;

  if (!newId) { showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
  if (newPw.length < 6) { showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§ã™', 'error'); return; }
  if (newPw !== newPw2) { showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error'); return; }

  localStorage.setItem('auth_id', newId);
  localStorage.setItem('auth_pw', newPw);
  $('new-userid').value = '';
  $('new-password').value = '';
  $('new-password2').value = '';
  showToast('âœ… ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ
window.addEventListener('load', () => {
  if (localStorage.getItem('session')) {
    showScreen('screen-home');
    const cred = getCredentials();
    $('greeting-user').textContent = cred.id;
    loadApiKey();
    updateUsageUI();
  }
  loadApiKey();
  scheduleUsageReset();
  updateNextResetTime();
});

// ============================================================
//  APIã‚­ãƒ¼ç®¡ç†
// ============================================================
function loadApiKey() {
  const key = localStorage.getItem('gemini_api_key') || '';
  $('settings-api-key').value = key;
}

function saveApiKey() {
  const key = $('settings-api-key').value.trim();
  if (!key) { showToast('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
  localStorage.setItem('gemini_api_key', key);
  showToast('âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

function getApiKey() {
  return localStorage.getItem('gemini_api_key') || '';
}

function toggleApiKeyVisibility() {
  const inp = $('settings-api-key');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

// ============================================================
//  åˆ©ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
// ============================================================
function getTodayKey() {
  const d = new Date();
  return `usage_day_${d.getFullYear()}${d.getMonth()}${d.getDate()}`;
}

function getMinKey() {
  return `usage_min_${Math.floor(Date.now() / 60000)}`;
}

function getUsage() {
  const dayUsage = parseInt(localStorage.getItem(getTodayKey()) || '0');
  const minUsage = parseInt(localStorage.getItem(getMinKey()) || '0');
  return { day: dayUsage, min: minUsage };
}

function incrementUsage() {
  const dk = getTodayKey();
  const mk = getMinKey();
  localStorage.setItem(dk, (parseInt(localStorage.getItem(dk) || '0') + 1).toString());
  localStorage.setItem(mk, (parseInt(localStorage.getItem(mk) || '0') + 1).toString());
  updateUsageUI();
}

function canCallApi() {
  const u = getUsage();
  if (u.min >= API_LIMIT_PER_MIN) {
    showToast(`â± 1åˆ†é–“ã®ä¸Šé™(${API_LIMIT_PER_MIN}å›)ã«é”ã—ã¾ã—ãŸã€‚å°‘ã—å¾…ã£ã¦ãã ã•ã„`, 'warn');
    return false;
  }
  if (u.day >= API_LIMIT_PER_DAY) {
    showToast(`ğŸ“… æœ¬æ—¥ã®ä¸Šé™(${API_LIMIT_PER_DAY}å›)ã«é”ã—ã¾ã—ãŸã€‚æ˜æ—¥ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™`, 'warn');
    return false;
  }
  return true;
}

function updateUsageUI() {
  const u = getUsage();

  // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒ¼
  $('cnt-min').textContent = u.min;
  $('cnt-day').textContent = u.day;

  const minPct = Math.min((u.min / API_LIMIT_PER_MIN) * 100, 100);
  const dayPct = Math.min((u.day / API_LIMIT_PER_DAY) * 100, 100);

  const minBar = $('bar-min');
  const dayBar = $('bar-day');
  const dotMin = $('dot-min');
  const dotDay = $('dot-day');

  minBar.style.width = `${minPct}%`;
  dayBar.style.width = `${dayPct}%`;

  // è‰²å¤‰ãˆ
  [minPct, dotMin, minBar].forEach(() => {});
  if (minPct >= 90) { minBar.style.background='var(--red)'; dotMin.className='usage-dot danger'; }
  else if (minPct >= 60) { minBar.style.background='var(--accent2)'; dotMin.className='usage-dot warn'; }
  else { minBar.style.background='var(--green)'; dotMin.className='usage-dot'; }

  if (dayPct >= 90) { dayBar.style.background='var(--red)'; dotDay.className='usage-dot danger'; }
  else if (dayPct >= 60) { dayBar.style.background='var(--accent2)'; dotDay.className='usage-dot warn'; }
  else { dayBar.style.background='var(--green)'; dotDay.className='usage-dot'; }

  // è¨­å®šç”»é¢ãƒãƒ¼
  $('stat-min-val').textContent = `${u.min} / ${API_LIMIT_PER_MIN}å›`;
  $('stat-day-val').textContent = `${u.day} / ${API_LIMIT_PER_DAY}å›`;

  const statMinBar = $('stat-min-bar');
  const statDayBar = $('stat-day-bar');
  statMinBar.style.width = `${minPct}%`;
  statDayBar.style.width = `${dayPct}%`;

  if (minPct >= 90) statMinBar.className='stat-fill danger';
  else if (minPct >= 60) statMinBar.className='stat-fill warn';
  else statMinBar.className='stat-fill';

  if (dayPct >= 90) statDayBar.className='stat-fill danger';
  else if (dayPct >= 60) statDayBar.className='stat-fill warn';
  else statDayBar.className='stat-fill';
}

function resetUsage() {
  localStorage.removeItem(getTodayKey());
  localStorage.removeItem(getMinKey());
  updateUsageUI();
  showToast('âœ… ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
}

function scheduleUsageReset() {
  setInterval(updateUsageUI, 15000);
}

function updateNextResetTime() {
  const now  = new Date();
  const next = new Date(now);
  next.setDate(next.getDate() + 1);
  next.setHours(0, 0, 0, 0);
  const h = Math.floor((next - now) / 3600000);
  const m = Math.floor(((next - now) % 3600000) / 60000);
  $('next-reset-time') && ($('next-reset-time').textContent = `ç´„${h}æ™‚é–“${m}åˆ†å¾Œ`);
  setTimeout(updateNextResetTime, 60000);
}

// ============================================================
//  ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
// ============================================================
let zxingScanner = null;

async function startScan() {
  try {
    const video = $('video-preview');
    const hints = new Map();
    // @zxing 0.20ç³»ã§ã¯DecodeHintsKeyãŒclassã«ç›´æ¥ã‚ã‚‹
    const ZXing = window.ZXing;
    const codeReader = new ZXing.BrowserMultiFormatReader();
    zxingScanner = codeReader;

    const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
    const backCam = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[devices.length - 1];
    const deviceId = backCam ? backCam.deviceId : undefined;

    codeReader.decodeFromVideoDevice(deviceId, 'video-preview', (result, err) => {
      if (result) {
        const code = result.getText();
        $('scan-result-box').style.display = 'block';
        $('scan-result-value').textContent = code;
        stopScan();
        showToast('âœ… ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šå®Œäº†ï¼', 'success');
        setTimeout(() => goToPriceFromBarcode(code), 600);
      }
    });
  } catch (e) {
    showToast('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚HTTPSç’°å¢ƒã§é–‹ã„ã¦ãã ã•ã„', 'error');
    console.error(e);
  }
}

function stopScan() {
  if (zxingScanner) {
    try { zxingScanner.reset(); } catch(e) {}
    zxingScanner = null;
  }
}

function goToPriceFromBarcode(code) {
  goToPriceScreen(code);
}

// ============================================================
//  å†™çœŸè§£æ
// ============================================================
let capturedBase64 = null;
let selectedProduct = null;

function onImageSelected(input) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const dataUrl = e.target.result;
    capturedBase64 = dataUrl.split(',')[1];

    const img = $('captured-img');
    img.src = dataUrl;
    img.classList.remove('hidden');
    $('capture-placeholder').classList.add('hidden');

    $('btn-analyze').disabled = false;
    $('candidate-section').classList.add('hidden');
    selectedProduct = null;
    $('btn-to-price').disabled = true;
  };
  reader.readAsDataURL(file);
}

async function analyzeImage() {
  if (!capturedBase64) return;

  const apiKey = getApiKey();
  if (!apiKey) {
    showToast('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã‚¿ãƒ–ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error', 3500);
    openModal('modal-api-support');
    return;
  }

  if (!canCallApi()) return;

  showLoading('AIãŒå•†å“ã‚’è§£æä¸­...');

  const prompt = `ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹å•†å“ã‚’æ—¥æœ¬èªã§åˆ†æã—ã¦ãã ã•ã„ã€‚
ãƒªã‚µã‚¤ã‚¯ãƒ«ã‚·ãƒ§ãƒƒãƒ—ã‚„ãƒ•ãƒªãƒã‚¢ãƒ—ãƒªã§å–å¼•ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å•†å“ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ç­”ã—ã¦ãã ã•ã„ï¼ˆä»–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸è¦ï¼‰:
{
  "candidates": [
    {
      "name": "å•†å“åï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰åãƒ»å‹ç•ªãƒ»ã‚·ãƒªãƒ¼ã‚ºåã‚’å«ã‚€å…·ä½“çš„ãªåå‰ï¼‰",
      "category": "ã‚«ãƒ†ã‚´ãƒªï¼ˆä¾‹: ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆ, ã‚«ãƒ¡ãƒ©, ãƒ–ãƒ©ãƒ³ãƒ‰è²¡å¸ƒ, ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼ãªã©ï¼‰",
      "confidence": 85,
      "search_query": "ãƒ¡ãƒ«ã‚«ãƒªãƒ»ãƒ¤ãƒ•ã‚ªã‚¯æ¤œç´¢ç”¨ã‚¯ã‚¨ãƒªï¼ˆç°¡æ½”ã«ï¼‰",
      "memo": "è»¢å£²ãƒã‚¤ãƒ³ãƒˆï¼ˆçŠ¶æ…‹ãƒ»ãƒ¬ã‚¢åº¦ãƒ»éœ€è¦ãªã©ä¸€è¨€ï¼‰"
    }
  ]
}

å€™è£œã¯æœ€å¤§5ä»¶ã€ä¿¡é ¼åº¦(confidence)ã¯0ã€œ100ã®æ•´æ•°ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚`;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: prompt },
              { inline_data: { mime_type: 'image/jpeg', data: capturedBase64 } }
            ]
          }],
          generationConfig: { temperature: 0.3, maxOutputTokens: 1024 }
        })
      }
    );

    incrementUsage();

    if (!response.ok) {
      const err = await response.json();
      const msg = err?.error?.message || `HTTP ${response.status}`;
      throw new Error(msg);
    }

    const data = await response.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';

    // JSONæŠ½å‡º
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('JSONãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

    const result = JSON.parse(jsonMatch[0]);
    hideLoading();
    displayCandidates(result.candidates || [], 'candidate-list', 'candidate-section', 'btn-to-price');

  } catch (e) {
    hideLoading();
    console.error(e);
    if (e.message.includes('API key')) {
      showToast('APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error', 4000);
    } else if (e.message.includes('quota') || e.message.includes('429')) {
      showToast('åˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ãã ã•ã„', 'warn', 4000);
    } else {
      showToast(`è§£æã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error', 4000);
    }
  }
}

// ============================================================
//  ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ â†’ å€™è£œç”Ÿæˆ
// ============================================================
async function doTextSearch() {
  const query = $('text-search-input').value.trim();
  if (!query) return;

  const apiKey = getApiKey();
  if (!apiKey) {
    // APIã‚­ãƒ¼ãªã—ã®å ´åˆã¯ç›´æ¥ä¾¡æ ¼ç”»é¢ã¸
    goToPriceScreen(query);
    return;
  }

  if (!canCallApi()) return;

  showLoading('å•†å“æƒ…å ±ã‚’æ¤œç´¢ä¸­...');

  const prompt = `ã€Œ${query}ã€ã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å•†å“å€™è£œã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ç­”ã—ã¦ãã ã•ã„:
{
  "candidates": [
    {
      "name": "å•†å“åï¼ˆã§ãã‚‹ã ã‘å…·ä½“çš„ã«ï¼‰",
      "category": "ã‚«ãƒ†ã‚´ãƒª",
      "confidence": 90,
      "search_query": "æ¤œç´¢ã‚¯ã‚¨ãƒª",
      "memo": "è»¢å£²ãƒã‚¤ãƒ³ãƒˆ"
    }
  ]
}

å€™è£œã¯æœ€å¤§5ä»¶ã€‚`;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.3, maxOutputTokens: 512 }
        })
      }
    );

    incrementUsage();

    const data = await response.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const jsonMatch = text.match(/\{[\s\S]*\}/);

    hideLoading();

    if (jsonMatch) {
      const result = JSON.parse(jsonMatch[0]);
      displayCandidates(result.candidates || [], 'text-candidate-list', 'text-candidate-section', 'btn-text-to-price');
    } else {
      goToPriceScreen(query);
    }
  } catch (e) {
    hideLoading();
    goToPriceScreen(query);
  }
}

function setSearchAndGo(query) {
  $('text-search-input').value = query;
  showScreen('screen-search');
  // APIä¸è¦ã®å ´åˆã¯ç›´æ¥ãƒªãƒ³ã‚¯ã¸
  const apiKey = getApiKey();
  if (!apiKey) {
    goToPriceScreen(query);
  } else {
    doTextSearch();
  }
}

function quickSearch(query) {
  $('text-search-input').value = query;
  showScreen('screen-search');
  const apiKey = getApiKey();
  if (!apiKey) {
    goToPriceScreen(query);
  } else {
    doTextSearch();
  }
}

// ============================================================
//  å€™è£œãƒªã‚¹ãƒˆè¡¨ç¤º
// ============================================================
function displayCandidates(candidates, listId, sectionId, btnId) {
  const list = $(listId);
  list.innerHTML = '';
  selectedProduct = null;
  $(btnId).disabled = true;

  candidates.forEach((c, i) => {
    const item = document.createElement('div');
    item.className = 'candidate-item';
    item.dataset.product = c.search_query || c.name;
    item.dataset.idx = i;

    const confColor = c.confidence >= 75 ? 'var(--green)'
                    : c.confidence >= 50 ? 'var(--accent2)'
                    : 'var(--red)';

    item.innerHTML = `
      <div class="candidate-num">${i + 1}</div>
      <div class="candidate-info">
        <div class="candidate-name">${c.name}</div>
        <div class="candidate-meta">ğŸ“‚ ${c.category} ãƒ» ğŸ’¬ ${c.memo || ''}</div>
        <div class="confidence-bar">
          <div class="confidence-fill" style="width:${c.confidence}%;background:${confColor}"></div>
        </div>
      </div>
    `;

    item.addEventListener('click', () => {
      list.querySelectorAll('.candidate-item').forEach(el => el.classList.remove('selected'));
      item.classList.add('selected');
      selectedProduct = c.search_query || c.name;
      $(btnId).disabled = false;
    });

    list.appendChild(item);
  });

  $(sectionId).classList.remove('hidden');
  $(sectionId).scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ============================================================
//  ä¾¡æ ¼ãƒªãƒ³ã‚¯ç”»é¢ã¸
// ============================================================
function goToPrice() {
  if (!selectedProduct) return;
  goToPriceScreen(selectedProduct);
}

function goToPriceScreen(query) {
  selectedProduct = query;
  $('price-product-name').textContent = `ğŸ” "${query}"`;
  renderPriceLinks(query);
  showScreen('screen-price');
}

function generatePriceLinks(query) {
  const enc = encodeURIComponent(query);
  return {
    sell: [
      {
        name: 'ãƒ¡ãƒ«ã‚«ãƒª',
        icon: 'ğŸ”´',
        type: 'sell',
        typeLabel: 'å£²å€¤',
        desc: 'å£²ã‚Šåˆ‡ã‚Œå•†å“ã§ç›¸å ´ç¢ºèª',
        url: `https://www.mercari.com/jp/search/?keyword=${enc}&status=sold_out`,
        btnText: 'å£²ã‚Šåˆ‡ã‚Œç›¸å ´ã‚’è¦‹ã‚‹'
      },
      {
        name: 'ãƒ¤ãƒ•ã‚ªã‚¯',
        icon: 'ğŸŸ¡',
        type: 'sell',
        typeLabel: 'å£²å€¤',
        desc: 'è½æœ­ç›¸å ´ã‚’ç¢ºèª',
        url: `https://closeout.auctions.yahoo.co.jp/search/closeout?p=${enc}&auccat=0`,
        btnText: 'è½æœ­ç›¸å ´ã‚’è¦‹ã‚‹'
      },
      {
        name: 'ãƒ©ã‚¯ãƒ',
        icon: 'ğŸŸ¢',
        type: 'sell',
        typeLabel: 'å£²å€¤',
        desc: 'å‡ºå“ç›¸å ´ï¼ˆä½æ‰‹æ•°æ–™ï¼‰',
        url: `https://fril.jp/search?query=${enc}&sold=true`,
        btnText: 'å£²ã‚Šåˆ‡ã‚Œã‚’è¦‹ã‚‹'
      },
      {
        name: 'PayPayãƒ•ãƒªãƒ',
        icon: 'ğŸ”µ',
        type: 'sell',
        typeLabel: 'å£²å€¤',
        desc: 'PayPayåˆ©ç”¨è€…ã«å¼·ã„',
        url: `https://paypayflea.market/search?query=${enc}`,
        btnText: 'ç›¸å ´ã‚’è¦‹ã‚‹'
      },
    ],
    buy: [
      {
        name: 'Amazon',
        icon: 'ğŸ“¦',
        type: 'both',
        typeLabel: 'å‚è€ƒ',
        desc: 'æ–°å“/ä¸­å¤å‚è€ƒä¾¡æ ¼',
        url: `https://www.amazon.co.jp/s?k=${enc}`,
        btnText: 'Amazonã§æ¤œç´¢'
      },
      {
        name: 'æ¥½å¤©å¸‚å ´',
        icon: 'ğŸ…¡',
        type: 'buy',
        typeLabel: 'æ–°å“',
        desc: 'å®šä¾¡ãƒ»æ–°å“å‚è€ƒä¾¡æ ¼',
        url: `https://search.rakuten.co.jp/search/mall/${enc}/`,
        btnText: 'æ¥½å¤©ã§æ¤œç´¢'
      },
      {
        name: 'Googleã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°',
        icon: 'ğŸ›’',
        type: 'both',
        typeLabel: 'æ¯”è¼ƒ',
        desc: 'å„åº—èˆ—ä¾¡æ ¼ã‚’ä¸€æ‹¬æ¯”è¼ƒ',
        url: `https://www.google.co.jp/search?q=${enc}&tbm=shop`,
        btnText: 'æœ€å®‰å€¤ã‚’æ¢ã™'
      },
      {
        name: 'eBayï¼ˆæµ·å¤–ï¼‰',
        icon: 'ğŸŒ',
        type: 'sell',
        typeLabel: 'æµ·å¤–',
        desc: 'æµ·å¤–è¼¸å‡ºå‘ã‘ç›¸å ´ç¢ºèª',
        url: `https://www.ebay.com/sch/i.html?_nkw=${enc}`,
        btnText: 'æµ·å¤–ç›¸å ´ã‚’è¦‹ã‚‹'
      },
    ],
    recycle: [
      {
        name: 'ã‚»ã‚«ãƒ³ãƒ‰ã‚¹ãƒˆãƒªãƒ¼ãƒˆ',
        icon: 'â™»ï¸',
        type: 'buy',
        typeLabel: 'ä»•å…¥ã‚Œ',
        desc: 'ãƒªã‚µã‚¤ã‚¯ãƒ«ã‚·ãƒ§ãƒƒãƒ—åœ¨åº«ç¢ºèª',
        url: `https://www.2ndstreet.jp/search/goods?keyword=${enc}`,
        btnText: 'åœ¨åº«ã‚’è¦‹ã‚‹'
      },
      {
        name: 'ãƒãƒ¼ãƒ‰ã‚ªãƒ•',
        icon: 'ğŸ”§',
        type: 'buy',
        typeLabel: 'ä»•å…¥ã‚Œ',
        desc: 'ã‚¸ãƒ£ãƒ³ã‚¯å“ãƒ»å®¶é›»',
        url: `https://www.hardoff.co.jp/shop/search?keyword=${enc}`,
        btnText: 'åœ¨åº«ã‚’è¦‹ã‚‹'
      },
      {
        name: 'ãƒˆãƒ¬ã‚¸ãƒ£ãƒ¼ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼',
        icon: 'ğŸª',
        type: 'buy',
        typeLabel: 'ä»•å…¥ã‚Œ',
        desc: 'ãƒ–ãƒ©ãƒ³ãƒ‰å“ãƒ»å®¶å…·',
        url: `https://www.treasure-f.com/search/?q=${enc}`,
        btnText: 'åœ¨åº«ã‚’è¦‹ã‚‹'
      },
      {
        name: 'ãƒ–ãƒƒã‚¯ã‚ªãƒ•',
        icon: 'ğŸ“š',
        type: 'buy',
        typeLabel: 'ä»•å…¥ã‚Œ',
        desc: 'æœ¬ãƒ»CDãƒ»ã‚²ãƒ¼ãƒ ',
        url: `https://shopping.bookoff.co.jp/search/keyword/${enc}/`,
        btnText: 'åœ¨åº«ã‚’è¦‹ã‚‹'
      },
    ]
  };
}

function renderPriceLinks(query) {
  const links = generatePriceLinks(query);

  function renderGrid(containerId, items) {
    const grid = $(containerId);
    grid.innerHTML = '';
    items.forEach(item => {
      const typeClass = `type-${item.type}`;
      const card = document.createElement('a');
      card.className = 'price-card';
      card.href = item.url;
      card.target = '_blank';
      card.rel = 'noopener noreferrer';
      card.innerHTML = `
        <div class="price-card-header">
          <span class="price-card-icon">${item.icon}</span>
          <div>
            <div class="price-card-name">${item.name}</div>
            <span class="price-card-type ${typeClass}">${item.typeLabel}</span>
          </div>
        </div>
        <div class="price-card-desc">${item.desc}</div>
        <div class="price-card-btn">${item.btnText} â†’</div>
      `;
      grid.appendChild(card);
    });
  }

  renderGrid('price-sell-grid', links.sell);
  renderGrid('price-buy-grid', links.buy);
  renderGrid('price-recycle-grid', links.recycle);
}

// ============================================================
//  Enter ã‚­ãƒ¼å¯¾å¿œ
// ============================================================
$('login-id').addEventListener('keydown', e => { if(e.key==='Enter') $('login-pw').focus(); });
$('login-pw').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

// ============================================================
//  ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
// ============================================================
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('active');
  });
});

</script>
</body>
</html>
