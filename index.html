<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0e1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ğŸï¸ ãƒã‚¤ã‚¯è»¢å£²ãƒŠãƒ“</title>
<script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0e1a;--bg2:#131929;--bg3:#1c2540;
  --accent:#ff6b35;--accent2:#ff9f1c;
  --blue:#4fc3f7;--green:#66bb6a;--red:#ef5350;
  --gold:#ffd700;
  --text:#e8eaf6;--text2:#90a4ae;
  --radius:12px;--shadow:0 4px 20px rgba(0,0,0,0.5)
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Hiragino Kaku Gothic ProN','Noto Sans JP',sans-serif;font-size:16px;overflow-x:hidden}
.hidden{display:none!important}
.screen{display:none;flex-direction:column;min-height:100vh;max-width:480px;margin:0 auto}
.screen.active{display:flex}

/* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== */
.loading-overlay{display:none;position:fixed;inset:0;background:rgba(10,14,26,0.92);z-index:300;flex-direction:column;align-items:center;justify-content:center;gap:20px}
.loading-overlay.active{display:flex}
.spinner{width:52px;height:52px;border:4px solid var(--bg3);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:15px;color:var(--text2)}

/* ===== ãƒˆãƒ¼ã‚¹ãƒˆ ===== */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg3);color:var(--text);padding:12px 20px;border-radius:24px;font-size:14px;font-weight:600;box-shadow:var(--shadow);z-index:400;transition:transform .3s ease;white-space:nowrap;max-width:90vw;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.success{background:var(--green);color:#fff}
.toast.error{background:var(--red);color:#fff}
.toast.warn{background:var(--accent2);color:#000}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:200;overflow-y:auto;padding:16px}
.modal-overlay.active{display:block}
.modal-card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);max-width:480px;margin:0 auto;overflow:hidden}
.modal-header{background:linear-gradient(135deg,var(--bg3),var(--bg2));padding:16px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--bg3)}
.modal-title{font-size:16px;font-weight:700;color:var(--accent)}
.modal-close{background:var(--bg3);border:none;border-radius:8px;width:34px;height:34px;color:var(--text2);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-body{padding:20px;display:flex;flex-direction:column;gap:16px}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
.app-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg2);border-bottom:1px solid var(--bg3);position:sticky;top:0;z-index:100;max-width:480px;margin:0 auto;width:100%}
.header-title{font-size:17px;font-weight:700;color:var(--accent)}
.header-actions{display:flex;gap:8px;align-items:center}
.icon-btn{background:var(--bg3);border:none;border-radius:8px;width:38px;height:38px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s;-webkit-tap-highlight-color:transparent;color:var(--text)}
.icon-btn:active{background:var(--bg)}

/* ===== åˆ©ç”¨ãƒãƒ¼ ===== */
.usage-bar{background:var(--bg2);padding:8px 16px;display:flex;gap:12px;justify-content:center;border-bottom:1px solid var(--bg3);max-width:480px;margin:0 auto;width:100%}
.usage-item{display:flex;align-items:center;gap:6px;font-size:12px}
.usage-dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
.usage-dot.warn{background:var(--accent2)}
.usage-dot.danger{background:var(--red)}
.usage-text{color:var(--text2)}
.usage-count{color:var(--text);font-weight:600}
.usage-mini-bar{flex:1;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;max-width:60px}
.usage-mini-fill{height:100%;border-radius:2px;background:var(--green);transition:width .3s,background .3s}

/* ===== ãƒœã‚¿ãƒ³ ===== */
.btn{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;padding:16px;color:white;font-size:16px;font-weight:700;cursor:pointer;transition:transform .1s,opacity .2s;-webkit-tap-highlight-color:transparent;letter-spacing:.5px;width:100%}
.btn:active{transform:scale(0.97)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-sm{padding:10px 16px;font-size:14px;width:auto}
.btn-outline{background:transparent;border:2px solid var(--accent);color:var(--accent);border-radius:10px;padding:14px;font-size:15px;font-weight:600;cursor:pointer;transition:background .2s,transform .1s;width:100%}
.btn-outline:active{transform:scale(0.97);background:rgba(255,107,53,.1)}
.btn-ghost{background:var(--bg3);border:1px solid rgba(255,255,255,.1);color:var(--text2);border-radius:10px;padding:14px;font-size:14px;cursor:pointer;transition:background .2s,transform .1s;width:100%}
.btn-ghost:active{transform:scale(0.97);background:var(--bg2)}
.btn-danger{background:linear-gradient(135deg,var(--red),#c62828);border:none;border-radius:10px;padding:12px 16px;color:white;font-size:14px;font-weight:700;cursor:pointer;-webkit-tap-highlight-color:transparent}
.btn-danger:active{transform:scale(0.97)}

/* ===== ãƒ•ã‚©ãƒ¼ãƒ  ===== */
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group label{font-size:12px;color:var(--text2);font-weight:600;letter-spacing:.5px;text-transform:uppercase}
.form-group input,.settings-input{background:var(--bg3);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:14px 16px;color:var(--text);font-size:16px;outline:none;transition:border-color .2s;-webkit-appearance:none;width:100%}
.form-group input:focus,.settings-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,107,53,.2)}

/* ===== ãƒ­ã‚°ã‚¤ãƒ³ ===== */
#screen-login{justify-content:center;align-items:center;gap:24px;background:radial-gradient(ellipse at center,#1a2040 0%,var(--bg) 70%);padding:24px}
.login-logo{font-size:72px;filter:drop-shadow(0 0 20px rgba(255,107,53,.6));animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{filter:drop-shadow(0 0 20px rgba(255,107,53,.6))}50%{filter:drop-shadow(0 0 35px rgba(255,107,53,.9))}}
.login-title{font-size:26px;font-weight:700;text-align:center;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.login-subtitle{color:var(--text2);font-size:13px;text-align:center}
.login-card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:28px 24px;width:100%;max-width:360px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:16px}
.login-error{background:rgba(239,83,80,.15);border:1px solid rgba(239,83,80,.4);border-radius:8px;padding:12px;font-size:13px;color:var(--red);text-align:center}

/* ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== */
.main-content{flex:1;padding:20px 16px;display:flex;flex-direction:column;gap:16px;max-width:480px;width:100%;margin:0 auto}
.section-title{font-size:15px;font-weight:700;color:var(--text2);letter-spacing:.5px;border-left:3px solid var(--accent);padding-left:10px}

/* ===== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ ===== */
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.action-card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:20px 16px;display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;transition:transform .15s,border-color .2s,box-shadow .2s;-webkit-tap-highlight-color:transparent;text-align:center}
.action-card:active{transform:scale(0.96);border-color:var(--accent);box-shadow:0 0 16px rgba(255,107,53,.25)}
.action-card.primary{grid-column:1/-1;flex-direction:row;text-align:left;gap:16px;background:linear-gradient(135deg,#1a2540 0%,#0d1629 100%);border-color:rgba(255,107,53,.3)}
.action-card.primary .action-icon{font-size:42px}
.action-icon{font-size:34px}
.action-label{font-size:14px;font-weight:600;color:var(--text)}
.action-desc{font-size:11px;color:var(--text2);line-height:1.4}

/* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===== */
.rank-list{display:flex;flex-direction:column;gap:8px}
.rank-item{background:var(--bg2);border:1px solid var(--bg3);border-radius:10px;padding:12px 14px;display:flex;align-items:center;gap:12px;cursor:pointer}
.rank-item:active{border-color:var(--accent)}
.rank-badge{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0}
.rank-badge.s{background:linear-gradient(135deg,#ffd700,#ffb300);color:#000}
.rank-badge.a{background:linear-gradient(135deg,#78909c,#546e7a);color:#fff}
.rank-badge.b{background:linear-gradient(135deg,#a1887f,#795548);color:#fff}
.rank-info{flex:1}
.rank-name{font-size:14px;font-weight:600}
.rank-profit{font-size:12px;color:var(--green);margin-top:2px}
.rank-diff{font-size:13px;font-weight:700;color:var(--accent);text-align:right}

/* ===== ã‚¹ã‚­ãƒ£ãƒ³ ===== */
.scan-content{flex:1;padding:16px;display:flex;flex-direction:column;gap:16px}
.video-wrapper{position:relative;width:100%;aspect-ratio:4/3;background:#000;border-radius:var(--radius);overflow:hidden;border:2px solid var(--bg3)}
#video-preview{width:100%;height:100%;object-fit:cover}
.scan-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none}
.scan-frame{width:60%;aspect-ratio:3/1;border:2px solid rgba(255,107,53,.8);border-radius:4px;box-shadow:0 0 0 9999px rgba(0,0,0,.45);position:relative}
.scan-frame::before{content:'';position:absolute;top:10%;left:10%;right:10%;height:2px;background:var(--accent);animation:scanline 2s ease-in-out infinite}
@keyframes scanline{0%{top:10%}100%{top:85%}}
.scan-hint{margin-top:16px;color:rgba(255,255,255,.7);font-size:13px;text-align:center;background:rgba(0,0,0,.5);padding:6px 14px;border-radius:20px}
.scan-result-box{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:14px}
.scan-result-label{font-size:11px;color:var(--text2);text-transform:uppercase;font-weight:600;letter-spacing:.5px}
.scan-result-value{font-size:18px;font-weight:700;color:var(--blue);margin-top:4px;word-break:break-all}

/* ===== å†™çœŸè§£æ ===== */
.photo-content{flex:1;padding:16px;display:flex;flex-direction:column;gap:16px}
.capture-area{width:100%;aspect-ratio:4/3;background:var(--bg2);border:2px dashed var(--bg3);border-radius:var(--radius);overflow:hidden;position:relative;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:border-color .2s}
.capture-area:active{border-color:var(--accent)}
.capture-placeholder{display:flex;flex-direction:column;align-items:center;gap:10px;color:var(--text2);pointer-events:none}
.capture-placeholder span{font-size:52px}
.capture-placeholder p{font-size:14px;text-align:center}
#captured-img{width:100%;height:100%;object-fit:contain}
#file-input-photo{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;font-size:0}

/* ===== å€™è£œãƒªã‚¹ãƒˆ ===== */
.candidate-list{display:flex;flex-direction:column;gap:10px}
.candidate-item{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:14px 16px;cursor:pointer;transition:border-color .2s,background .2s;display:flex;align-items:center;gap:12px;-webkit-tap-highlight-color:transparent}
.candidate-item:active,.candidate-item.selected{border-color:var(--accent);background:rgba(255,107,53,.08)}
.candidate-num{width:30px;height:30px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:var(--text2);flex-shrink:0}
.candidate-item.selected .candidate-num{background:var(--accent);color:#fff}
.candidate-info{flex:1}
.candidate-name{font-size:14px;font-weight:600}
.candidate-meta{font-size:12px;color:var(--text2);margin-top:2px}
.confidence-bar{width:50px;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;margin-top:4px}
.confidence-fill{height:100%;border-radius:3px;background:var(--green)}

/* ===== ä¾¡æ ¼ç”»é¢ ===== */
.price-content{flex:1;padding:16px;display:flex;flex-direction:column;gap:16px}
.price-product-name{background:var(--bg2);border-radius:var(--radius);padding:14px;font-size:15px;font-weight:600;border-left:4px solid var(--accent)}
.price-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.price-card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:14px 12px;display:flex;flex-direction:column;gap:8px;cursor:pointer;text-decoration:none;transition:transform .15s,border-color .2s}
.price-card:active{transform:scale(0.96);border-color:var(--accent)}
.price-card-header{display:flex;align-items:center;gap:8px}
.price-card-icon{font-size:22px}
.price-card-name{font-size:13px;font-weight:600;color:var(--text2)}
.price-card-type{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600}
.type-buy{background:rgba(102,187,106,.2);color:var(--green)}
.type-sell{background:rgba(255,107,53,.2);color:var(--accent)}
.type-both{background:rgba(79,195,247,.2);color:var(--blue)}
.price-card-desc{font-size:11px;color:var(--text2);line-height:1.5}
.price-card-btn{background:var(--bg3);border-radius:6px;padding:7px;text-align:center;font-size:12px;color:var(--text);font-weight:600;margin-top:2px}

/* ===== æ¤œç´¢ ===== */
.search-bar{display:flex;gap:8px}
.search-input{flex:1;background:var(--bg2);border:1px solid var(--bg3);border-radius:10px;padding:14px 16px;color:var(--text);font-size:15px;outline:none;-webkit-appearance:none}
.search-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,107,53,.15)}
.search-btn{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;padding:14px 18px;color:white;font-size:20px;cursor:pointer;-webkit-tap-highlight-color:transparent}

/* ===== è¨­å®š ===== */
.settings-content{flex:1;padding:16px;display:flex;flex-direction:column;gap:16px}
.settings-section{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);overflow:hidden}
.settings-section-title{padding:12px 16px;font-size:13px;font-weight:700;color:var(--text2);background:var(--bg3);letter-spacing:.5px;text-transform:uppercase}
.settings-row{padding:14px 16px;display:flex;flex-direction:column;gap:8px;border-bottom:1px solid var(--bg3)}
.settings-row:last-child{border-bottom:none}
.settings-label{font-size:14px;font-weight:600}
.settings-desc{font-size:12px;color:var(--text2);line-height:1.5}
.api-key-row{display:flex;gap:8px}
.api-key-row .settings-input{flex:1}
.toggle-visibility{background:var(--bg3);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:0 14px;color:var(--text2);font-size:18px;cursor:pointer;flex-shrink:0}

/* ===== åˆ©ç”¨çµ±è¨ˆ ===== */
.usage-stats{padding:14px 16px;display:flex;flex-direction:column;gap:12px}
.stat-row{display:flex;flex-direction:column;gap:6px}
.stat-label-row{display:flex;justify-content:space-between;align-items:center}
.stat-label{font-size:13px;color:var(--text2)}
.stat-value{font-size:13px;font-weight:700}
.stat-bar{height:8px;background:var(--bg3);border-radius:4px;overflow:hidden}
.stat-fill{height:100%;border-radius:4px;background:var(--green);transition:width .4s,background .4s}
.stat-fill.warn{background:var(--accent2)}
.stat-fill.danger{background:var(--red)}

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† ===== */
.user-card{background:var(--bg3);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px}
.user-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;flex-shrink:0}
.user-avatar.admin{background:linear-gradient(135deg,var(--gold),#ffb300);color:#000}
.user-avatar.user{background:linear-gradient(135deg,var(--blue),#0288d1);color:#fff}
.user-info{flex:1}
.user-name{font-size:14px;font-weight:700}
.user-role{font-size:11px;color:var(--text2);margin-top:2px}
.user-actions{display:flex;gap:6px}

/* ===== ã‚¿ãƒ–ãƒãƒ¼ ===== */
.tab-bar{display:flex;background:var(--bg2);border-top:1px solid var(--bg3);position:sticky;bottom:0;z-index:50;max-width:480px;margin:0 auto;width:100%}
.tab-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 4px;cursor:pointer;transition:color .2s;-webkit-tap-highlight-color:transparent;color:var(--text2);font-size:10px;gap:3px;border:none;background:none}
.tab-item.active{color:var(--accent)}
.tab-icon{font-size:22px}

/* ===== API ã‚µãƒãƒ¼ãƒˆ ===== */
.step-card{background:var(--bg3);border-radius:10px;padding:16px;display:flex;gap:14px}
.step-num{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.step-body{flex:1}
.step-title{font-size:14px;font-weight:700;margin-bottom:6px}
.step-desc{font-size:13px;color:var(--text2);line-height:1.6}
.step-link{display:inline-block;margin-top:8px;background:var(--accent);color:white;text-decoration:none;padding:8px 14px;border-radius:8px;font-size:13px;font-weight:600}
.step-code{background:var(--bg);border-radius:6px;padding:8px 12px;font-family:monospace;font-size:13px;color:var(--blue);margin-top:6px;word-break:break-all}
.info-box{background:rgba(79,195,247,.1);border:1px solid rgba(79,195,247,.3);border-radius:10px;padding:14px;font-size:13px;color:var(--blue);line-height:1.6}
.warn-box{background:rgba(255,159,28,.1);border:1px solid rgba(255,159,28,.3);border-radius:10px;padding:14px;font-size:13px;color:var(--accent2);line-height:1.6}
.success-box{background:rgba(102,187,106,.1);border:1px solid rgba(102,187,106,.3);border-radius:10px;padding:14px;font-size:13px;color:var(--green);line-height:1.6}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:2px}
</style>
</head>
<body>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loading-text">è§£æä¸­...</div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
<div class="toast" id="toast"></div>

<!-- ========== APIã‚µãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
<div class="modal-overlay" id="modal-api-support">
  <div class="modal-card">
    <div class="modal-header">
      <span class="modal-title">ğŸ”‘ Gemini APIã‚­ãƒ¼å–å¾—ã‚¬ã‚¤ãƒ‰</span>
      <button class="modal-close" onclick="closeModal('modal-api-support')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="info-box">ğŸ“Œ Gemini APIã¯å°‚ç”¨Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆ1ã¤ã§<strong>1æ—¥1,500å›ãƒ»ç„¡æ–™</strong>ã§ä½¿ãˆã¾ã™ã€‚</div>
      <div class="step-card"><div class="step-num">1</div><div class="step-body"><div class="step-title">Google AI Studioã«ã‚¢ã‚¯ã‚»ã‚¹</div><div class="step-desc">ä»¥ä¸‹ãƒªãƒ³ã‚¯ã‹ã‚‰Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆå°‚ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚‚OKï¼‰</div><a class="step-link" href="https://aistudio.google.com/app/apikey" target="_blank">ğŸŒ Google AI Studio ã‚’é–‹ã</a></div></div>
      <div class="step-card"><div class="step-num">2</div><div class="step-body"><div class="step-title">ã€ŒAPIã‚­ãƒ¼ã‚’ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯</div><div class="step-desc">å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒGet API keyã€â†’ã€Œæ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§APIã‚­ãƒ¼ã‚’ä½œæˆã€</div></div></div>
      <div class="step-card"><div class="step-num">3</div><div class="step-body"><div class="step-title">ã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼</div><div class="step-desc">ç™ºè¡Œã•ã‚ŒãŸã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™</div><div class="step-code">AIzaSyã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ã€‡ï¼ˆä¾‹ï¼‰</div></div></div>
      <div class="step-card"><div class="step-num">4</div><div class="step-body"><div class="step-title">è¨­å®šã‚¿ãƒ–ã«è²¼ã‚Šä»˜ã‘</div><div class="step-desc">âš™ï¸è¨­å®š â†’ ã€ŒGemini APIã‚­ãƒ¼ã€æ¬„ã«ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ã€Œä¿å­˜ã€</div></div></div>
      <div class="warn-box">âš ï¸ <strong>ç„¡æ–™æ ã®ä¸Šé™</strong><br>â€¢ 1åˆ†é–“ã«15å›ã¾ã§<br>â€¢ 1æ—¥1,500å›ã¾ã§</div>
      <button class="btn" onclick="closeModal('modal-api-support')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
<div class="modal-overlay" id="modal-add-user">
  <div class="modal-card">
    <div class="modal-header">
      <span class="modal-title">ğŸ‘¤ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </span>
      <button class="modal-close" onclick="closeModal('modal-add-user')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
        <input type="text" id="add-user-id" placeholder="è‹±æ•°å­—ï¼ˆä¾‹: tanakaï¼‰" autocapitalize="none">
      </div>
      <div class="form-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="add-user-pw" placeholder="6æ–‡å­—ä»¥ä¸Š">
      </div>
      <div class="form-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
        <input type="password" id="add-user-pw2" placeholder="å†å…¥åŠ›">
      </div>
      <div class="form-group">
        <label>æ¨©é™</label>
        <select id="add-user-role" style="background:var(--bg3);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:14px 16px;color:var(--text);font-size:16px;outline:none;-webkit-appearance:none;width:100%">
          <option value="user">ğŸ‘¤ ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
          <option value="admin">ğŸ‘‘ ç®¡ç†è€…</option>
        </select>
      </div>
      <button class="btn" onclick="addUser()">è¿½åŠ ã™ã‚‹</button>
      <button class="btn-ghost" onclick="closeModal('modal-add-user')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- ========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
<div class="modal-overlay" id="modal-change-pw">
  <div class="modal-card">
    <div class="modal-header">
      <span class="modal-title">ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</span>
      <button class="modal-close" onclick="closeModal('modal-change-pw')">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="change-pw-target-info" style="background:var(--bg3);border-radius:8px;padding:12px;font-size:14px;"></div>
      <div class="form-group">
        <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="change-pw-new" placeholder="6æ–‡å­—ä»¥ä¸Š">
      </div>
      <div class="form-group">
        <label>ç¢ºèª</label>
        <input type="password" id="change-pw-new2" placeholder="å†å…¥åŠ›">
      </div>
      <button class="btn" onclick="saveChangePw()">å¤‰æ›´ã™ã‚‹</button>
      <button class="btn-ghost" onclick="closeModal('modal-change-pw')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- ========== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ========== -->
<div class="screen active" id="screen-login">
  <div class="login-logo">ğŸï¸</div>
  <div class="login-title">ãƒã‚¤ã‚¯è»¢å£²ãƒŠãƒ“</div>
  <div class="login-subtitle">ä»•å…¥ã‚Œâ†’ç›¸å ´ç¢ºèªâ†’åˆ©ç›Šæœ€å¤§åŒ–</div>
  <div class="login-card">
    <div class="form-group">
      <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
      <input type="text" id="login-id" placeholder="IDã‚’å…¥åŠ›" autocomplete="username" autocapitalize="none">
    </div>
    <div class="form-group">
      <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="password" id="login-pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="current-password">
    </div>
    <div class="login-error hidden" id="login-error">âŒ IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™</div>
    <button class="btn" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>
</div>

<!-- ========== ãƒ›ãƒ¼ãƒ ç”»é¢ ========== -->
<div class="screen" id="screen-home">
  <div class="app-header">
    <div class="header-title">ğŸï¸ è»¢å£²ãƒŠãƒ“</div>
    <div class="header-actions">
      <span id="header-role-badge" style="font-size:11px;padding:4px 8px;border-radius:6px;font-weight:700;"></span>
      <button class="icon-btn" onclick="openModal('modal-api-support')">ğŸ”‘</button>
      <button class="icon-btn" onclick="doLogout()">ğŸšª</button>
    </div>
  </div>
  <div class="usage-bar">
    <div class="usage-item">
      <div class="usage-dot" id="dot-min"></div>
      <span class="usage-text">ä»Šåˆ†:</span>
      <span class="usage-count" id="cnt-min">0</span><span class="usage-text">/15</span>
      <div class="usage-mini-bar"><div class="usage-mini-fill" id="bar-min" style="width:0%"></div></div>
    </div>
    <div class="usage-item">
      <div class="usage-dot" id="dot-day"></div>
      <span class="usage-text">ä»Šæ—¥:</span>
      <span class="usage-count" id="cnt-day">0</span><span class="usage-text">/1500</span>
      <div class="usage-mini-bar"><div class="usage-mini-fill" id="bar-day" style="width:0%"></div></div>
    </div>
  </div>
  <div class="main-content">
    <div style="font-size:20px;font-weight:700;">ã‚ˆã†ã“ãã€<span id="greeting-user" style="color:var(--accent)">ãƒ©ã‚¤ãƒ€ãƒ¼</span>ã•ã‚“ğŸ‘‹</div>
    <div class="action-grid">
      <div class="action-card primary" onclick="showScreen('screen-photo')">
        <div class="action-icon">ğŸ“·</div>
        <div><div class="action-label">å†™çœŸã§AIè§£æ</div><div class="action-desc">å•†å“ã‚’æ’®å½±ã—ã¦AIãŒè‡ªå‹•ç‰¹å®šãƒ»ç›¸å ´ã‚’è¡¨ç¤º</div></div>
      </div>
      <div class="action-card" onclick="showScreen('screen-scan')">
        <div class="action-icon">ğŸ“¦</div><div class="action-label">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</div><div class="action-desc">JAN/EANã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
      </div>
      <div class="action-card" onclick="showScreen('screen-search')">
        <div class="action-icon">ğŸ”</div><div class="action-label">ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</div><div class="action-desc">å•†å“åã§ç›¸å ´ç¢ºèª</div>
      </div>
      <div class="action-card" onclick="openModal('modal-api-support')">
        <div class="action-icon">ğŸ”‘</div><div class="action-label">APIè¨­å®š</div><div class="action-desc">Geminiã‚­ãƒ¼å–å¾—ã‚¬ã‚¤ãƒ‰</div>
      </div>
    </div>
    <div class="section-title">ãŠã™ã™ã‚è»¢å£²å•†å“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    <div class="rank-list">
      <div class="rank-item" onclick="quickSearch('ãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆ PS2 ãƒ•ã‚¡ãƒŸã‚³ãƒ³')"><div class="rank-badge s">S</div><div class="rank-info"><div class="rank-name">ğŸ® ãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆ</div><div class="rank-profit">ä»•å…¥500å††ã€œ / åˆ©ç›Š1,000ã€œ8,000å††</div></div><div class="rank-diff">x8å€</div></div>
      <div class="rank-item" onclick="quickSearch('éŠæˆ¯ç‹ã‚«ãƒ¼ãƒ‰ MTGãƒˆãƒ¬ã‚« ãƒ¬ã‚¢')"><div class="rank-badge s">S</div><div class="rank-info"><div class="rank-name">ğŸƒ ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰</div><div class="rank-profit">ä»•å…¥100å††ã€œ / åˆ©ç›Š300ã€œ10,000å††</div></div><div class="rank-diff">x10å€</div></div>
      <div class="rank-item" onclick="quickSearch('Nikon Canon ãƒ¬ãƒ³ã‚º ãƒ•ã‚£ãƒ«ãƒ ã‚«ãƒ¡ãƒ©')"><div class="rank-badge s">S</div><div class="rank-info"><div class="rank-name">ğŸ“¸ ã‚«ãƒ¡ãƒ©ãƒ»ãƒ¬ãƒ³ã‚º</div><div class="rank-profit">ä»•å…¥1,500å††ã€œ / åˆ©ç›Š2,000ã€œ15,000å††</div></div><div class="rank-diff">x6å€</div></div>
      <div class="rank-item" onclick="quickSearch('Paul Smith COACH è²¡å¸ƒ ãƒ–ãƒ©ãƒ³ãƒ‰')"><div class="rank-badge s">S</div><div class="rank-info"><div class="rank-name">ğŸ‘œ ãƒ–ãƒ©ãƒ³ãƒ‰è²¡å¸ƒãƒ»å°ç‰©</div><div class="rank-profit">ä»•å…¥1,000å††ã€œ / åˆ©ç›Š3,000ã€œ15,000å††</div></div><div class="rank-diff">x5å€</div></div>
      <div class="rank-item" onclick="quickSearch('ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹ ãƒ‘ã‚¿ã‚´ãƒ‹ã‚¢ ãƒ¢ãƒ³ãƒ™ãƒ« ã‚¸ãƒ£ã‚±ãƒƒãƒˆ')"><div class="rank-badge a">A</div><div class="rank-info"><div class="rank-name">ğŸ§¥ ãƒ–ãƒ©ãƒ³ãƒ‰å¤ç€</div><div class="rank-profit">ä»•å…¥1,500å††ã€œ / åˆ©ç›Š3,000ã€œ10,000å††</div></div><div class="rank-diff">x4å€</div></div>
      <div class="rank-item" onclick="quickSearch('Nike ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼ ã‚³ãƒ©ãƒœ é™å®š')"><div class="rank-badge a">A</div><div class="rank-info"><div class="rank-name">ğŸ‘Ÿ é™å®šã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼</div><div class="rank-profit">ä»•å…¥2,500å††ã€œ / åˆ©ç›Š3,000ã€œ15,000å††</div></div><div class="rank-diff">x5å€</div></div>
      <div class="rank-item" onclick="quickSearch('LEGO ãƒ¬ã‚´ å»ƒç›¤ ãƒ¬ã‚¢ ã‚»ãƒƒãƒˆ')"><div class="rank-badge a">A</div><div class="rank-info"><div class="rank-name">ğŸ§± LEGOãƒ»ãƒŸãƒ‹å››é§†</div><div class="rank-profit">ä»•å…¥500å††ã€œ / åˆ©ç›Š1,500ã€œ8,000å††</div></div><div class="rank-diff">x5å€</div></div>
      <div class="rank-item" onclick="quickSearch('ã‚¹ãƒãƒ¼ãƒ”ãƒ¼ã‚¯ ã‚³ãƒ¼ãƒ«ãƒãƒ³ ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ å°ç‰©')"><div class="rank-badge b">B</div><div class="rank-info"><div class="rank-name">â›º ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢å°ç‰©</div><div class="rank-profit">ä»•å…¥500å††ã€œ / åˆ©ç›Š1,500ã€œ8,000å††</div></div><div class="rank-diff">x4å€</div></div>
    </div>
  </div>
  <div class="tab-bar">
    <button class="tab-item active" onclick="showScreen('screen-home');setActiveTab(this)"><span class="tab-icon">ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
    <button class="tab-item" onclick="showScreen('screen-photo');setActiveTab(this)"><span class="tab-icon">ğŸ“·</span>å†™çœŸ</button>
    <button class="tab-item" onclick="showScreen('screen-scan');setActiveTab(this)"><span class="tab-icon">ğŸ“¦</span>ã‚¹ã‚­ãƒ£ãƒ³</button>
    <button class="tab-item" onclick="showScreen('screen-search');setActiveTab(this)"><span class="tab-icon">ğŸ”</span>æ¤œç´¢</button>
    <button class="tab-item" onclick="showScreen('screen-settings');setActiveTab(this)"><span class="tab-icon">âš™ï¸</span>è¨­å®š</button>
  </div>
</div>

<!-- ========== ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç”»é¢ ========== -->
<div class="screen" id="screen-scan">
  <div class="app-header">
    <button class="icon-btn" onclick="goBack()">â—€</button>
    <div class="header-title">ğŸ“¦ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</div>
    <div style="width:38px"></div>
  </div>
  <div class="scan-content">
    <div class="video-wrapper">
      <video id="video-preview" playsinline autoplay muted></video>
      <div class="scan-overlay"><div class="scan-frame"></div><div class="scan-hint">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ»QRã‚³ãƒ¼ãƒ‰ã‚’ãƒ©ã‚¤ãƒ³ã«åˆã‚ã›ã¦</div></div>
    </div>
    <div class="scan-result-box hidden" id="scan-result-box">
      <div class="scan-result-label">ã‚¹ã‚­ãƒ£ãƒ³çµæœ</div>
      <div class="scan-result-value" id="scan-result-value"></div>
    </div>
    <button class="btn-ghost" onclick="stopScan()">ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
  </div>
</div>

<!-- ========== å†™çœŸè§£æç”»é¢ ========== -->
<div class="screen" id="screen-photo">
  <div class="app-header">
    <button class="icon-btn" onclick="goBack()">â—€</button>
    <div class="header-title">ğŸ“· å†™çœŸã§AIè§£æ</div>
    <button class="icon-btn" onclick="openModal('modal-api-support')">ğŸ”‘</button>
  </div>
  <div class="photo-content">
    <div class="capture-area" id="capture-area">
      <div class="capture-placeholder" id="capture-placeholder"><span>ğŸ“·</span><p>ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’æ’®å½±<br>ã¾ãŸã¯é¸æŠ</p></div>
      <img id="captured-img" class="hidden">
      <input type="file" id="file-input-photo" accept="image/*" capture="environment" onchange="onImageSelected(this)">
    </div>
    <button class="btn" id="btn-analyze" onclick="analyzeImage()" disabled>AIè§£æé–‹å§‹ ğŸ”</button>
    <div id="candidate-section" class="hidden">
      <div class="section-title" style="margin-bottom:10px">å€™è£œå•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div class="candidate-list" id="candidate-list"></div>
      <button class="btn" id="btn-to-price" onclick="goToPrice()" style="margin-top:12px" disabled>ã“ã®å•†å“ã§ç›¸å ´ã‚’è¦‹ã‚‹ â†’</button>
    </div>
  </div>
</div>

<!-- ========== ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ç”»é¢ ========== -->
<div class="screen" id="screen-search">
  <div class="app-header">
    <button class="icon-btn" onclick="goBack()">â—€</button>
    <div class="header-title">ğŸ” ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</div>
    <div style="width:38px"></div>
  </div>
  <div style="padding:16px;display:flex;flex-direction:column;gap:16px;">
    <div class="search-bar">
      <input class="search-input" id="text-search-input" type="text" placeholder="ä¾‹: PS2 ãƒ­ãƒã‚µã‚¬ã€ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹ ãƒ‘ãƒ¼ã‚«ãƒ¼" onkeydown="if(event.key==='Enter')doTextSearch()">
      <button class="search-btn" onclick="doTextSearch()">ğŸ”</button>
    </div>
    <div id="text-candidate-section" class="hidden">
      <div class="section-title" style="margin-bottom:10px">å€™è£œå•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div class="candidate-list" id="text-candidate-list"></div>
      <button class="btn" id="btn-text-to-price" onclick="goToPrice()" style="margin-top:12px" disabled>ã“ã®å•†å“ã§ç›¸å ´ã‚’è¦‹ã‚‹ â†’</button>
    </div>
    <div class="section-title">ğŸ’¡ ã‚ˆãèª¿ã¹ã‚‹å•†å“ã‚¿ã‚°</div>
    <div style="display:flex;flex-wrap:wrap;gap:8px;">
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;width:auto;" onclick="setSearchAndGo('PS2 ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆ')">ğŸ® PS2ã‚½ãƒ•ãƒˆ</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;width:auto;" onclick="setSearchAndGo('éŠæˆ¯ç‹ ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰')">ğŸƒ éŠæˆ¯ç‹</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;width:auto;" onclick="setSearchAndGo('ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹ ã‚¸ãƒ£ã‚±ãƒƒãƒˆ')">ğŸ§¥ ãƒãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ã‚¹</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;width:auto;" onclick="setSearchAndGo('Nikon ãƒ¬ãƒ³ã‚º')">ğŸ“¸ Nikonãƒ¬ãƒ³ã‚º</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;width:auto;" onclick="setSearchAndGo('LEGO ãƒ¬ã‚´ å»ƒç›¤')">ğŸ§± LEGOå»ƒç›¤</button>
      <button class="btn-ghost" style="padding:8px 14px;font-size:13px;border-radius:20px;width:auto;" onclick="setSearchAndGo('Nike ã‚¨ã‚¢ãƒ•ã‚©ãƒ¼ã‚¹ ã‚³ãƒ©ãƒœ')">ğŸ‘Ÿ Nikeã‚³ãƒ©ãƒœ</button>
    </div>
  </div>
</div>

<!-- ========== ä¾¡æ ¼ãƒªãƒ³ã‚¯ç”»é¢ ========== -->
<div class="screen" id="screen-price">
  <div class="app-header">
    <button class="icon-btn" onclick="goBack()">â—€</button>
    <div class="header-title">ğŸ’° å„ã‚µã‚¤ãƒˆç›¸å ´</div>
    <div style="width:38px"></div>
  </div>
  <div class="price-content">
    <div class="price-product-name" id="price-product-name">å•†å“å</div>
    <div class="section-title">ğŸ”´ ãƒ•ãƒªãƒãƒ»ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå£²å€¤ç›¸å ´ï¼‰</div>
    <div class="price-grid" id="price-sell-grid"></div>
    <div class="section-title">ğŸ”µ ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ï¼ˆä»•å…¥ã‚Œå‚è€ƒï¼‰</div>
    <div class="price-grid" id="price-buy-grid"></div>
    <div class="section-title">ğŸŸ¢ ä»•å…¥ã‚Œå…ˆï¼ˆãƒªã‚µã‚¤ã‚¯ãƒ«ã‚·ãƒ§ãƒƒãƒ—ï¼‰</div>
    <div class="price-grid" id="price-recycle-grid"></div>
  </div>
</div>

<!-- ========== è¨­å®šç”»é¢ ========== -->
<div class="screen" id="screen-settings">
  <div class="app-header">
    <button class="icon-btn" onclick="goBack()">â—€</button>
    <div class="header-title">âš™ï¸ è¨­å®š</div>
    <div style="width:38px"></div>
  </div>
  <div class="settings-content">

    <!-- APIã‚­ãƒ¼ -->
    <div class="settings-section">
      <div class="settings-section-title">ğŸ”‘ Gemini APIã‚­ãƒ¼ï¼ˆå€‹äººè¨­å®šï¼‰</div>
      <div class="settings-row">
        <div class="settings-label">APIã‚­ãƒ¼ <span style="font-size:11px;color:var(--green);font-weight:400;">â€»ãƒ­ã‚°ã‚¤ãƒ³IDã”ã¨ã«åˆ¥ã€…ã«ä¿å­˜</span></div>
        <div class="api-key-row">
          <input class="settings-input" type="password" id="settings-api-key" placeholder="AIzaSy...">
          <button class="toggle-visibility" onclick="toggleApiKeyVisibility()">ğŸ‘</button>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn" style="flex:1" onclick="saveApiKey()">ä¿å­˜</button>
          <button class="btn-outline" style="width:auto;padding:14px 12px;font-size:13px;" onclick="openModal('modal-api-support')">å–å¾—æ–¹æ³•</button>
        </div>
      </div>
    </div>

    <!-- åˆ©ç”¨çŠ¶æ³ -->
    <div class="settings-section">
      <div class="settings-section-title">ğŸ“Š APIåˆ©ç”¨çŠ¶æ³ï¼ˆå€‹äººï¼‰</div>
      <div class="usage-stats">
        <div class="stat-row">
          <div class="stat-label-row"><span class="stat-label">ä»Šåˆ†ã®åˆ©ç”¨å›æ•°</span><span class="stat-value" id="stat-min-val">0 / 15å›</span></div>
          <div class="stat-bar"><div class="stat-fill" id="stat-min-bar" style="width:0%"></div></div>
        </div>
        <div class="stat-row">
          <div class="stat-label-row"><span class="stat-label">ä»Šæ—¥ã®åˆ©ç”¨å›æ•°</span><span class="stat-value" id="stat-day-val">0 / 1500å›</span></div>
          <div class="stat-bar"><div class="stat-fill" id="stat-day-bar" style="width:0%"></div></div>
        </div>
        <div style="font-size:12px;color:var(--text2);line-height:1.6;">ğŸ“… æ¬¡ã®æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆ: <span id="next-reset-time">-</span></div>
        <button class="btn-ghost" onclick="resetUsage()">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆæœ¬äººï¼‰ -->
    <div class="settings-section">
      <div class="settings-section-title">ğŸ”’ è‡ªåˆ†ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</div>
      <div class="settings-row">
        <input class="settings-input" type="password" id="my-pw-new" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰">
      </div>
      <div class="settings-row">
        <input class="settings-input" type="password" id="my-pw-new2" placeholder="ç¢ºèªã®ãŸã‚å†å…¥åŠ›">
      </div>
      <div class="settings-row" style="border-bottom:none;">
        <button class="btn" onclick="changeMyPassword()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
      </div>
    </div>

    <!-- ç®¡ç†è€…å°‚ç”¨ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† -->
    <div class="settings-section" id="admin-section" style="display:none">
      <div class="settings-section-title">ğŸ‘‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰</div>
      <div style="padding:14px 16px;display:flex;flex-direction:column;gap:12px;">
        <div id="user-list-container" style="display:flex;flex-direction:column;gap:8px;"></div>
        <button class="btn" onclick="openModal('modal-add-user')">ï¼‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ </button>
      </div>
    </div>

    <button class="btn-ghost" onclick="doLogout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<script>
/* ==========================================================
   â˜… åˆæœŸç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
     ã“ã“ã‚’å¤‰æ›´ â†’ GitHubã«å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§å…¨ç«¯æœ«ã«åæ˜ 
   ========================================================== */
const INITIAL_ADMIN = { id: 'admin', pw: 'sedori2025', role: 'admin' };

const API_LIMIT_MIN = 15;
const API_LIMIT_DAY = 1500;

/* ==========================================================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ========================================================== */
const $ = id => document.getElementById(id);
let currentUser = null; // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

function showToast(msg, type='', dur=2800){
  const t=$('toast'); t.textContent=msg; t.className=`toast ${type} show`;
  setTimeout(()=>t.className='toast', dur);
}
function showLoading(msg='è§£æä¸­...'){$('loading-text').textContent=msg;$('loading').classList.add('active')}
function hideLoading(){$('loading').classList.remove('active')}
function openModal(id){$(id).classList.add('active')}
function closeModal(id){$(id).classList.remove('active')}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')}));

/* ==========================================================
   ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
   users_db = [ {id, pw, role}, ... ]
   ========================================================== */
function loadUsers(){
  try{
    const raw = localStorage.getItem('users_db');
    if(raw) return JSON.parse(raw);
  }catch(e){}
  // åˆå›ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç®¡ç†è€…ã‚’ç™»éŒ²
  const db = [INITIAL_ADMIN];
  saveUsers(db);
  return db;
}
function saveUsers(db){ localStorage.setItem('users_db', JSON.stringify(db)); }

function findUser(id){
  return loadUsers().find(u => u.id === id);
}

function addUser(){
  const id   = $('add-user-id').value.trim();
  const pw   = $('add-user-pw').value;
  const pw2  = $('add-user-pw2').value;
  const role = $('add-user-role').value;

  if(!id || !/^[a-zA-Z0-9_\-]+$/.test(id)){ showToast('IDã¯è‹±æ•°å­—/ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã§å…¥åŠ›','error'); return; }
  if(pw.length < 6){ showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Š','error'); return; }
  if(pw !== pw2){ showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“','error'); return; }

  const db = loadUsers();
  if(db.find(u=>u.id===id)){ showToast(`IDã€Œ${id}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™`,'error'); return; }

  db.push({id, pw, role});
  saveUsers(db);
  closeModal('modal-add-user');
  $('add-user-id').value=''; $('add-user-pw').value=''; $('add-user-pw2').value='';
  showToast(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${id}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`,'success');
  renderUserList();
}

function deleteUser(id){
  if(id === currentUser.id){ showToast('è‡ªåˆ†è‡ªèº«ã¯å‰Šé™¤ã§ãã¾ã›ã‚“','error'); return; }
  if(!confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${id}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  const db = loadUsers().filter(u=>u.id!==id);
  saveUsers(db);
  showToast(`ğŸ—‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${id}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`,'warn');
  renderUserList();
}

let changePwTargetId = null;
function openChangePwModal(id){
  changePwTargetId = id;
  $('change-pw-target-info').textContent = `å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${id}`;
  $('change-pw-new').value=''; $('change-pw-new2').value='';
  openModal('modal-change-pw');
}
function saveChangePw(){
  const pw  = $('change-pw-new').value;
  const pw2 = $('change-pw-new2').value;
  if(pw.length < 6){ showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Š','error'); return; }
  if(pw !== pw2){ showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“','error'); return; }
  const db = loadUsers();
  const idx = db.findIndex(u=>u.id===changePwTargetId);
  if(idx<0){ showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“','error'); return; }
  db[idx].pw = pw;
  saveUsers(db);
  closeModal('modal-change-pw');
  showToast(`âœ… ã€Œ${changePwTargetId}ã€ã®PWã‚’å¤‰æ›´ã—ã¾ã—ãŸ`,'success');
}

function changeMyPassword(){
  const pw  = $('my-pw-new').value;
  const pw2 = $('my-pw-new2').value;
  if(pw.length < 6){ showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Š','error'); return; }
  if(pw !== pw2){ showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“','error'); return; }
  const db = loadUsers();
  const idx = db.findIndex(u=>u.id===currentUser.id);
  if(idx<0){ showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“','error'); return; }
  db[idx].pw = pw;
  saveUsers(db);
  $('my-pw-new').value=''; $('my-pw-new2').value='';
  showToast('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ','success');
}

function renderUserList(){
  const db = loadUsers();
  const container = $('user-list-container');
  container.innerHTML = '';
  db.forEach(u=>{
    const isAdmin = u.role==='admin';
    const div = document.createElement('div');
    div.className = 'user-card';
    div.innerHTML = `
      <div class="user-avatar ${isAdmin?'admin':'user'}">${isAdmin?'ğŸ‘‘':'ğŸ‘¤'}</div>
      <div class="user-info">
        <div class="user-name">${u.id}</div>
        <div class="user-role">${isAdmin?'ç®¡ç†è€…':'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</div>
      </div>
      <div class="user-actions">
        <button class="btn-sm btn" style="padding:8px 10px;font-size:12px;width:auto;" onclick="openChangePwModal('${u.id}')">PWå¤‰æ›´</button>
        ${u.id!==currentUser.id ? `<button class="btn-danger" style="padding:8px 10px;font-size:12px;" onclick="deleteUser('${u.id}')">å‰Šé™¤</button>` : '<span style="font-size:11px;color:var(--text2);padding:8px 4px;">ï¼ˆè‡ªåˆ†ï¼‰</span>'}
      </div>`;
    container.appendChild(div);
  });
}

/* ==========================================================
   ç”»é¢ç®¡ç†
   ========================================================== */
const screens = ['screen-login','screen-home','screen-scan','screen-photo','screen-search','screen-price','screen-settings'];
let screenHistory = [];

function showScreen(id){
  const prev = screens.find(s=>$(s).classList.contains('active'));
  if(prev && prev!==id) screenHistory.push(prev);
  screens.forEach(s=>$(s).classList.remove('active'));
  $(id).classList.add('active');
  if(id==='screen-scan') startScan(); else stopScan();
  if(id==='screen-settings'){ loadApiKey(); updateUsageUI(); updateNextResetTime(); }
}
function goBack(){
  if(screenHistory.length){ const p=screenHistory.pop(); screens.forEach(s=>$(s).classList.remove('active')); $(p).classList.add('active'); if(p==='screen-scan') startScan(); else stopScan(); }
  else showScreen('screen-home');
}
function setActiveTab(el){ document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active')); el.classList.add('active'); }

/* ==========================================================
   èªè¨¼
   ========================================================== */
function doLogin(){
  const id = $('login-id').value.trim();
  const pw = $('login-pw').value;
  const user = findUser(id);

  if(user && user.pw===pw){
    $('login-error').classList.add('hidden');
    currentUser = user;
    sessionStorage.setItem('session_user', id);
    onLoginSuccess();
  } else {
    $('login-error').classList.remove('hidden');
    $('login-pw').value='';
  }
}

function onLoginSuccess(){
  $('greeting-user').textContent = currentUser.id;

  // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¸
  const badge = $('header-role-badge');
  if(currentUser.role==='admin'){
    badge.textContent='ğŸ‘‘ ç®¡ç†è€…';
    badge.style.cssText='font-size:11px;padding:4px 8px;border-radius:6px;font-weight:700;background:rgba(255,215,0,.2);color:var(--gold)';
    $('admin-section').style.display='block';
    renderUserList();
  } else {
    badge.textContent='ğŸ‘¤';
    badge.style.cssText='font-size:11px;padding:4px 8px;border-radius:6px;font-weight:700;background:rgba(79,195,247,.15);color:var(--blue)';
    $('admin-section').style.display='none';
  }

  loadApiKey();
  updateUsageUI();
  scheduleUsageReset();
  updateNextResetTime();
  showScreen('screen-home');
}

function doLogout(){
  sessionStorage.removeItem('session_user');
  currentUser=null;
  stopScan();
  screenHistory=[];
  screens.forEach(s=>$(s).classList.remove('active'));
  $('screen-login').classList.add('active');
  $('login-id').value=''; $('login-pw').value='';
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ
window.addEventListener('load',()=>{
  const savedId = sessionStorage.getItem('session_user');
  if(savedId){
    const user = findUser(savedId);
    if(user){ currentUser=user; onLoginSuccess(); return; }
  }
  // åˆå›ãªã‚‰DBã‚’åˆæœŸåŒ–
  loadUsers();
});

/* ==========================================================
   APIã‚­ãƒ¼ç®¡ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ï¼‰
   ========================================================== */
function apiKeyName(){ return `gemini_key_${currentUser?.id||'default'}`; }
function loadApiKey(){ $('settings-api-key').value = localStorage.getItem(apiKeyName())||''; }
function saveApiKey(){
  const key=$('settings-api-key').value.trim();
  if(!key){ showToast('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; }
  localStorage.setItem(apiKeyName(), key);
  showToast('âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ','success');
}
function getApiKey(){ return localStorage.getItem(apiKeyName())||''; }
function toggleApiKeyVisibility(){ const i=$('settings-api-key'); i.type=i.type==='password'?'text':'password'; }

/* ==========================================================
   åˆ©ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ï¼‰
   ========================================================== */
function uid(){ return currentUser?.id||'anon'; }
function getTodayKey(){ const d=new Date(); return `usage_day_${uid()}_${d.getFullYear()}${d.getMonth()}${d.getDate()}`; }
function getMinKey(){ return `usage_min_${uid()}_${Math.floor(Date.now()/60000)}`; }
function getUsage(){ return { day:parseInt(localStorage.getItem(getTodayKey())||'0'), min:parseInt(localStorage.getItem(getMinKey())||'0') }; }
function incrementUsage(){
  const dk=getTodayKey(),mk=getMinKey();
  localStorage.setItem(dk,(parseInt(localStorage.getItem(dk)||'0')+1).toString());
  localStorage.setItem(mk,(parseInt(localStorage.getItem(mk)||'0')+1).toString());
  updateUsageUI();
}
function canCallApi(){
  const u=getUsage();
  if(u.min>=API_LIMIT_MIN){ showToast(`â± 1åˆ†é–“ã®ä¸Šé™(${API_LIMIT_MIN}å›)ã«é”ã—ã¾ã—ãŸ`,'warn'); return false; }
  if(u.day>=API_LIMIT_DAY){ showToast(`ğŸ“… æœ¬æ—¥ã®ä¸Šé™(${API_LIMIT_DAY}å›)ã«é”ã—ã¾ã—ãŸ`,'warn'); return false; }
  return true;
}
function updateUsageUI(){
  const u=getUsage();
  $('cnt-min').textContent=u.min; $('cnt-day').textContent=u.day;
  const mp=Math.min((u.min/API_LIMIT_MIN)*100,100);
  const dp=Math.min((u.day/API_LIMIT_DAY)*100,100);
  function setBar(barId,dotId,pct){
    const b=$(barId),d=$(dotId);
    b.style.width=`${pct}%`;
    if(pct>=90){b.style.background='var(--red)';d.className='usage-dot danger';}
    else if(pct>=60){b.style.background='var(--accent2)';d.className='usage-dot warn';}
    else{b.style.background='var(--green)';d.className='usage-dot';}
  }
  setBar('bar-min','dot-min',mp); setBar('bar-day','dot-day',dp);
  // è¨­å®šç”»é¢
  $('stat-min-val').textContent=`${u.min} / ${API_LIMIT_MIN}å›`;
  $('stat-day-val').textContent=`${u.day} / ${API_LIMIT_DAY}å›`;
  function setStatBar(id,pct){
    const b=$(id);
    b.style.width=`${pct}%`;
    b.className=pct>=90?'stat-fill danger':pct>=60?'stat-fill warn':'stat-fill';
  }
  setStatBar('stat-min-bar',mp); setStatBar('stat-day-bar',dp);
}
function resetUsage(){ localStorage.removeItem(getTodayKey()); localStorage.removeItem(getMinKey()); updateUsageUI(); showToast('âœ… ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ','success'); }
function scheduleUsageReset(){ setInterval(updateUsageUI,15000); }
function updateNextResetTime(){
  const now=new Date(),next=new Date(now);
  next.setDate(next.getDate()+1); next.setHours(0,0,0,0);
  const h=Math.floor((next-now)/3600000),m=Math.floor(((next-now)%3600000)/60000);
  if($('next-reset-time')) $('next-reset-time').textContent=`ç´„${h}æ™‚é–“${m}åˆ†å¾Œ`;
  setTimeout(updateNextResetTime,60000);
}

/* ==========================================================
   ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
   ========================================================== */
let zxingScanner=null;
async function startScan(){
  try{
    const ZXing=window.ZXing;
    const codeReader=new ZXing.BrowserMultiFormatReader();
    zxingScanner=codeReader;
    const devices=await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
    const back=devices.find(d=>/back|rear|environment/i.test(d.label))||devices[devices.length-1];
    codeReader.decodeFromVideoDevice(back?.deviceId,'video-preview',(result,err)=>{
      if(result){
        const code=result.getText();
        $('scan-result-box').classList.remove('hidden');
        $('scan-result-value').textContent=code;
        stopScan();
        showToast('âœ… ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šå®Œäº†ï¼','success');
        setTimeout(()=>goToPriceScreen(code),600);
      }
    });
  }catch(e){ showToast('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ï¼ˆHTTPSå¿…é ˆï¼‰','error'); }
}
function stopScan(){ if(zxingScanner){ try{zxingScanner.reset();}catch(e){} zxingScanner=null; } }

/* ==========================================================
   å†™çœŸè§£æ
   ========================================================== */
let capturedBase64=null, selectedProduct=null;

function onImageSelected(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    capturedBase64=e.target.result.split(',')[1];
    const img=$('captured-img'); img.src=e.target.result; img.classList.remove('hidden');
    $('capture-placeholder').classList.add('hidden');
    $('btn-analyze').disabled=false;
    $('candidate-section').classList.add('hidden'); selectedProduct=null; $('btn-to-price').disabled=true;
  };
  reader.readAsDataURL(file);
}

async function analyzeImage(){
  if(!capturedBase64) return;
  const apiKey=getApiKey();
  if(!apiKey){ showToast('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“','error',3500); openModal('modal-api-support'); return; }
  if(!canCallApi()) return;
  showLoading('AIãŒå•†å“ã‚’è§£æä¸­...');
  const prompt=`ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹å•†å“ã‚’æ—¥æœ¬èªã§åˆ†æã—ã¦ãã ã•ã„ã€‚ãƒªã‚µã‚¤ã‚¯ãƒ«ã‚·ãƒ§ãƒƒãƒ—ã‚„ãƒ•ãƒªãƒã‚¢ãƒ—ãƒªã§å–å¼•ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å•†å“ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ç­”ã—ã¦ãã ã•ã„:
{"candidates":[{"name":"å•†å“åï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰åãƒ»å‹ç•ªã‚’å«ã‚€å…·ä½“çš„ãªåå‰ï¼‰","category":"ã‚«ãƒ†ã‚´ãƒª","confidence":85,"search_query":"ãƒ¡ãƒ«ã‚«ãƒªãƒ»ãƒ¤ãƒ•ã‚ªã‚¯æ¤œç´¢ç”¨ã‚¯ã‚¨ãƒª","memo":"è»¢å£²ãƒã‚¤ãƒ³ãƒˆä¸€è¨€"}]}
å€™è£œã¯æœ€å¤§5ä»¶ã€confidence ã¯0ã€œ100ã®æ•´æ•°ã€‚`;
  try{
    const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{parts:[{text:prompt},{inline_data:{mime_type:'image/jpeg',data:capturedBase64}}]}],generationConfig:{temperature:0.3,maxOutputTokens:1024}})
    });
    incrementUsage();
    if(!res.ok){ const e=await res.json(); throw new Error(e?.error?.message||`HTTP ${res.status}`); }
    const data=await res.json();
    const text=data?.candidates?.[0]?.content?.parts?.[0]?.text||'';
    const m=text.match(/\{[\s\S]*\}/); if(!m) throw new Error('JSONãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    const result=JSON.parse(m[0]);
    hideLoading();
    displayCandidates(result.candidates||[],'candidate-list','candidate-section','btn-to-price');
  }catch(e){
    hideLoading();
    if(e.message.includes('API key')) showToast('APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™','error',4000);
    else if(e.message.includes('quota')||e.message.includes('429')) showToast('åˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸ','warn',4000);
    else showToast(`è§£æã‚¨ãƒ©ãƒ¼: ${e.message}`,'error',4000);
  }
}

/* ==========================================================
   ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
   ========================================================== */
async function doTextSearch(){
  const query=$('text-search-input').value.trim(); if(!query) return;
  const apiKey=getApiKey();
  if(!apiKey){ goToPriceScreen(query); return; }
  if(!canCallApi()) return;
  showLoading('å•†å“æƒ…å ±ã‚’æ¤œç´¢ä¸­...');
  const prompt=`ã€Œ${query}ã€ã§æ¤œç´¢ã•ã‚Œã‚‹å•†å“å€™è£œã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
JSONå½¢å¼ã®ã¿ã§è¿”ç­”:
{"candidates":[{"name":"å•†å“å","category":"ã‚«ãƒ†ã‚´ãƒª","confidence":90,"search_query":"æ¤œç´¢ã‚¯ã‚¨ãƒª","memo":"è»¢å£²ãƒã‚¤ãƒ³ãƒˆ"}]}
å€™è£œã¯æœ€å¤§5ä»¶ã€‚`;
  try{
    const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.3,maxOutputTokens:512}})
    });
    incrementUsage();
    const data=await res.json();
    const text=data?.candidates?.[0]?.content?.parts?.[0]?.text||'';
    const m=text.match(/\{[\s\S]*\}/);
    hideLoading();
    if(m){ const r=JSON.parse(m[0]); displayCandidates(r.candidates||[],'text-candidate-list','text-candidate-section','btn-text-to-price'); }
    else goToPriceScreen(query);
  }catch(e){ hideLoading(); goToPriceScreen(query); }
}

function setSearchAndGo(q){ $('text-search-input').value=q; showScreen('screen-search'); setTimeout(()=>{ if(getApiKey()) doTextSearch(); else goToPriceScreen(q); },100); }
function quickSearch(q){ $('text-search-input').value=q; showScreen('screen-search'); setTimeout(()=>{ if(getApiKey()) doTextSearch(); else goToPriceScreen(q); },100); }

/* ==========================================================
   å€™è£œãƒªã‚¹ãƒˆè¡¨ç¤º
   ========================================================== */
function displayCandidates(candidates,listId,sectionId,btnId){
  const list=$(listId); list.innerHTML=''; selectedProduct=null; $(btnId).disabled=true;
  candidates.forEach((c,i)=>{
    const cc=c.confidence>=75?'var(--green)':c.confidence>=50?'var(--accent2)':'var(--red)';
    const item=document.createElement('div'); item.className='candidate-item'; item.dataset.product=c.search_query||c.name;
    item.innerHTML=`<div class="candidate-num">${i+1}</div><div class="candidate-info"><div class="candidate-name">${c.name}</div><div class="candidate-meta">ğŸ“‚ ${c.category} ãƒ» ğŸ’¬ ${c.memo||''}</div><div class="confidence-bar"><div class="confidence-fill" style="width:${c.confidence}%;background:${cc}"></div></div></div>`;
    item.addEventListener('click',()=>{ list.querySelectorAll('.candidate-item').forEach(el=>el.classList.remove('selected')); item.classList.add('selected'); selectedProduct=c.search_query||c.name; $(btnId).disabled=false; });
    list.appendChild(item);
  });
  $(sectionId).classList.remove('hidden'); $(sectionId).scrollIntoView({behavior:'smooth',block:'start'});
}

/* ==========================================================
   ä¾¡æ ¼ãƒªãƒ³ã‚¯ç”»é¢
   ========================================================== */
function goToPrice(){ if(selectedProduct) goToPriceScreen(selectedProduct); }
function goToPriceScreen(query){
  selectedProduct=query; $('price-product-name').textContent=`ğŸ” "${query}"`;
  renderPriceLinks(query); showScreen('screen-price');
}
function generatePriceLinks(query){
  const enc=encodeURIComponent(query);
  return {
    sell:[
      {name:'ãƒ¡ãƒ«ã‚«ãƒª',icon:'ğŸ”´',type:'sell',typeLabel:'å£²å€¤',desc:'å£²ã‚Šåˆ‡ã‚Œå•†å“ã§ç›¸å ´ç¢ºèª',url:`https://www.mercari.com/jp/search/?keyword=${enc}&status=sold_out`,btnText:'å£²ã‚Šåˆ‡ã‚Œç›¸å ´ã‚’è¦‹ã‚‹'},
      {name:'ãƒ¤ãƒ•ã‚ªã‚¯',icon:'ğŸŸ¡',type:'sell',typeLabel:'å£²å€¤',desc:'è½æœ­ç›¸å ´ã‚’ç¢ºèª',url:`https://closeout.auctions.yahoo.co.jp/search/closeout?p=${enc}`,btnText:'è½æœ­ç›¸å ´ã‚’è¦‹ã‚‹'},
      {name:'ãƒ©ã‚¯ãƒ',icon:'ğŸŸ¢',type:'sell',typeLabel:'å£²å€¤',desc:'å‡ºå“ç›¸å ´ï¼ˆä½æ‰‹æ•°æ–™ï¼‰',url:`https://fril.jp/search?query=${enc}&sold=true`,btnText:'å£²ã‚Šåˆ‡ã‚Œã‚’è¦‹ã‚‹'},
      {name:'PayPayãƒ•ãƒªãƒ',icon:'ğŸ”µ',type:'sell',typeLabel:'å£²å€¤',desc:'PayPayåˆ©ç”¨è€…ã«å¼·ã„',url:`https://paypayflea.market/search?query=${enc}`,btnText:'ç›¸å ´ã‚’è¦‹ã‚‹'},
    ],
    buy:[
      {name:'Amazon',icon:'ğŸ“¦',type:'both',typeLabel:'å‚è€ƒ',desc:'æ–°å“/ä¸­å¤å‚è€ƒä¾¡æ ¼',url:`https://www.amazon.co.jp/s?k=${enc}`,btnText:'Amazonã§æ¤œç´¢'},
      {name:'æ¥½å¤©å¸‚å ´',icon:'ğŸ…¡',type:'buy',typeLabel:'æ–°å“',desc:'å®šä¾¡ãƒ»æ–°å“å‚è€ƒä¾¡æ ¼',url:`https://search.rakuten.co.jp/search/mall/${enc}/`,btnText:'æ¥½å¤©ã§æ¤œç´¢'},
      {name:'Googleã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°',icon:'ğŸ›’',type:'both',typeLabel:'æ¯”è¼ƒ',desc:'å„åº—èˆ—ä¾¡æ ¼ã‚’ä¸€æ‹¬æ¯”è¼ƒ',url:`https://www.google.co.jp/search?q=${enc}&tbm=shop`,btnText:'æœ€å®‰å€¤ã‚’æ¢ã™'},
      {name:'eBayï¼ˆæµ·å¤–ï¼‰',icon:'ğŸŒ',type:'sell',typeLabel:'æµ·å¤–',desc:'æµ·å¤–è¼¸å‡ºå‘ã‘ç›¸å ´ç¢ºèª',url:`https://www.ebay.com/sch/i.html?_nkw=${enc}`,btnText:'æµ·å¤–ç›¸å ´ã‚’è¦‹ã‚‹'},
    ],
    recycle:[
      {name:'ã‚»ã‚«ãƒ³ãƒ‰ã‚¹ãƒˆãƒªãƒ¼ãƒˆ',icon:'â™»ï¸',type:'buy',typeLabel:'ä»•å…¥ã‚Œ',desc:'ãƒªã‚µã‚¤ã‚¯ãƒ«ã‚·ãƒ§ãƒƒãƒ—åœ¨åº«',url:`https://www.2ndstreet.jp/search/goods?keyword=${enc}`,btnText:'åœ¨åº«ã‚’è¦‹ã‚‹'},
      {name:'ãƒãƒ¼ãƒ‰ã‚ªãƒ•',icon:'ğŸ”§',type:'buy',typeLabel:'ä»•å…¥ã‚Œ',desc:'ã‚¸ãƒ£ãƒ³ã‚¯å“ãƒ»å®¶é›»',url:`https://www.hardoff.co.jp/shop/search?keyword=${enc}`,btnText:'åœ¨åº«ã‚’è¦‹ã‚‹'},
      {name:'ãƒˆãƒ¬ã‚¸ãƒ£ãƒ¼ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼',icon:'ğŸª',type:'buy',typeLabel:'ä»•å…¥ã‚Œ',desc:'ãƒ–ãƒ©ãƒ³ãƒ‰å“ãƒ»å®¶å…·',url:`https://www.treasure-f.com/search/?q=${enc}`,btnText:'åœ¨åº«ã‚’è¦‹ã‚‹'},
      {name:'ãƒ–ãƒƒã‚¯ã‚ªãƒ•',icon:'ğŸ“š',type:'buy',typeLabel:'ä»•å…¥ã‚Œ',desc:'æœ¬ãƒ»CDãƒ»ã‚²ãƒ¼ãƒ ',url:`https://shopping.bookoff.co.jp/search/keyword/${enc}/`,btnText:'åœ¨åº«ã‚’è¦‹ã‚‹'},
    ]
  };
}
function renderPriceLinks(query){
  const links=generatePriceLinks(query);
  function renderGrid(id,items){
    const g=$(id); g.innerHTML='';
    items.forEach(item=>{
      const a=document.createElement('a'); a.className='price-card'; a.href=item.url; a.target='_blank'; a.rel='noopener noreferrer';
      a.innerHTML=`<div class="price-card-header"><span class="price-card-icon">${item.icon}</span><div><div class="price-card-name">${item.name}</div><span class="price-card-type type-${item.type}">${item.typeLabel}</span></div></div><div class="price-card-desc">${item.desc}</div><div class="price-card-btn">${item.btnText} â†’</div>`;
      g.appendChild(a);
    });
  }
  renderGrid('price-sell-grid',links.sell);
  renderGrid('price-buy-grid',links.buy);
  renderGrid('price-recycle-grid',links.recycle);
}

/* ==========================================================
   Enterã‚­ãƒ¼
   ========================================================== */
$('login-id').addEventListener('keydown',e=>{if(e.key==='Enter')$('login-pw').focus()});
$('login-pw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
</script>
</body>
</html>
